# WinCapture MVP 代码质量检查清单

## 一、编译失败根因分析

### 1.1 常见编译错误类型

| 错误类型 | 出现次数 | 根因 | 预防措施 |
|----------|----------|------|----------|
| 缺少 using 语句 | 多次 | 手动添加时遗漏 | 使用 IDE 自动修复 |
| null 引用警告 | 多次 | 可空引用类型启用但未正确处理 | 统一使用 `??` 和 `?.` |
| 类型不匹配 | 较少 | 返回值未正确处理 | 显式类型声明 |
| 资源未释放 | 多次 | using 语句使用不一致 | 统一使用 try-finally |

### 1.2 编译失败模式

**模式1: 循环依赖修复**
```
发现问题 → 修复 → 引入新问题 → 修复 → 编译失败
```

**模式2: 版本混乱**
```
v4.1 → v4.2 → v4.3 → v4.4 → v4.5 → v5.0 → v5.1 → v5.2 → v5.3 → v5.4 → v5.5 → v5.6
改动分散，难以追踪
```

**模式3: 上下文丢失**
```
长时间对话 → 忘记之前改动 → 重复修复 → 冲突
```

---

## 二、代码风格不一致问题

### 2.1 检查发现

| 检查项 | 状态 | 问题 |
|--------|------|------|
| using 语句排序 | ❌ | 不统一，有的按字母，有的按功能 |
| 空行使用 | ❌ | 有的地方过多，有的地方过少 |
| 括号风格 | ✅ | 统一使用 K&R 风格 |
| 缩进 | ✅ | 统一使用 4 空格 |
| 命名规范 | ⚠️ | 基本统一，但局部变量有混用 |

### 2.2 null 检查风格混乱

**发现多种写法：**
```csharp
// 写法1: 传统判断
if (x == null)

// 写法2: is 模式
if (x is null)

// 写法3: 空合并
x ?? "default"

// 写法4: 空条件
x?.Property

// 写法5: 可空类型
string? x
```

**建议统一为：**
- 参数检查: `x ?? throw new ...`
- 属性访问: `x?.Property ?? default`
- 条件判断: `if (x is null)` 或 `if (x is not null)`

---

## 三、架构层面的问题

### 3.1 依赖关系

```
Program
  ├── CaptureEngine
  │     ├── WindowSwitchTrigger → User32 API
  │     ├── IntervalTrigger
  │     ├── WorkLogStorage → SQLite
  │     └── OcrEngine → PaddleOCRSharp
  ├── TrayIcon
  └── ConfigForm
```

**问题:**
- 没有接口隔离
- 直接依赖具体实现
- 难以单元测试

### 3.2 错误处理策略不一致

| 层级 | 当前处理 | 问题 |
|------|----------|------|
| UI 层 | MessageBox.Show | 阻塞用户 |
| 业务层 | Debug.WriteLine | 生产环境不可见 |
| 数据层 | 抛出异常 | 上层处理不一致 |

**建议:**
- 统一使用日志系统
- 分级处理：致命/错误/警告/信息
- 用户友好的错误提示

---

## 四、具体代码问题清单

### 4.1 高风险问题

| 位置 | 问题 | 风险 |
|------|------|------|
| `OcrEngine.cs:260` | 静态构造函数异常捕获后 `_initFailed=true` 但无提示 | 静默失败 |
| `WorkLogStorage.cs:45` | 内存数据库回退时数据丢失 | 数据丢失 |
| `CaptureEngine.cs:78` | OCR 失败继续执行，可能记录空数据 | 脏数据 |

### 4.2 中风险问题

| 位置 | 问题 | 风险 |
|------|------|------|
| `WindowHelper.cs` | P/Invoke 无 SetLastError | 错误信息丢失 |
| `ImageHelper.cs` | 未检查图像格式 | 潜在异常 |
| `TrayIcon.cs` | 菜单事件无 try-catch | 崩溃风险 |

### 4.3 低风险问题

| 位置 | 问题 | 风险 |
|------|------|------|
| 多处 | 字符串拼接性能 | 可优化 |
| 多处 | 魔法数字 | 可读性 |

---

## 五、预防措施建议

### 5.1 立即实施

1. **添加 EditorConfig**
   - 统一代码风格
   - 自动格式化

2. **添加 Git 预提交钩子**
   - 编译检查
   - 格式检查

3. **统一日志系统**
   - 替换所有 Debug.WriteLine
   - 分级日志

### 5.2 短期实施

1. **添加单元测试**
   - 核心逻辑测试
   - 边界条件测试

2. **添加集成测试**
   - 数据库操作
   - OCR 调用

3. **代码审查清单**
   - 提交前自检

### 5.3 长期实施

1. **重构架构**
   - 依赖注入
   - 接口隔离

2. **CI/CD 流程**
   - 自动构建
   - 自动测试

---

## 六、版本管理改进

### 6.1 当前问题

- 版本号跳跃 (v4.5 → v5.0)
- 多个 test 版本
- 改动分散

### 6.2 建议方案

使用语义化版本：
```
主版本.次版本.修订号-标签

例如：
5.6.0-beta
5.6.0-rc1
5.6.0
```

---

检查时间: 2026-02-20 17:50
检查人: Kimi
