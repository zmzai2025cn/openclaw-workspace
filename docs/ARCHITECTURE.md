# 架构设计文档

## 设计原则

1. **简单优先**：避免过度设计
2. **可观测**：全链路监控
3. **可恢复**：故障自动恢复
4. **安全**：分层脱敏，加密传输

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         客户端层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ WinCapture   │  │ WinCapture   │  │    ...       │      │
│  │ (C#版)       │  │ (Electron)   │  │              │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
└─────────┼─────────────────┼─────────────────┼──────────────┘
          │                 │                 │
          └─────────────────┼─────────────────┘
                            │ HTTPS
┌───────────────────────────▼───────────────────────────────┐
│                       接入层                               │
│                    Nginx/ALB                               │
│              (SSL终止/负载均衡/限流)                        │
└───────────────────────────┬───────────────────────────────┘
                            │
┌───────────────────────────▼───────────────────────────────┐
│                      服务层                                │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                 Kimiclaw DB                         │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌────────┐ │  │
│  │  │ API服务  │  │ 解析器   │  │ 存储引擎 │  │ 任务调度│ │  │
│  │  └────┬────┘  └────┬────┘  └────┬────┘  └───┬────┘ │  │
│  │       └─────────────┴─────────────┴──────────┘       │  │
│  └─────────────────────────────────────────────────────┘  │
└───────────────────────────┬───────────────────────────────┘
                            │
┌───────────────────────────▼───────────────────────────────┐
│                      数据层                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   DuckDB     │  │   SQLite     │  │   文件存储    │     │
│  │  (时序数据)   │  │  (配置缓存)   │  │  (备份/日志)  │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└───────────────────────────────────────────────────────────┘
```

---

## 数据流

### 采集流程

```
1. 触发检测（窗口切换/像素变化/定时）
       ↓
2. 屏幕截图（GDI+/Electron API）
       ↓
3. 分层脱敏（人脸模糊 → AES加密）
       ↓
4. 本地缓存（SQLite队列）
       ↓
5. HTTPS上传（批量/压缩）
       ↓
6. 服务端存储（DuckDB时序表）
       ↓
7. 会话聚合（定时任务）
       ↓
8. 分析展示（Web面板）
```

### 飞书消息流程

```
1. 飞书服务器推送Webhook
       ↓
2. 服务端接收验证签名
       ↓
3. 消息解析（9种格式）
       ↓
4. 上下文关联
       ↓
5. 存储到DuckDB
       ↓
6. 与采集数据关联
```

---

## 模块设计

### 客户端模块

| 模块 | 职责 | 关键类/文件 |
|------|------|-------------|
| 触发器 | 检测采集时机 | WindowSwitchTrigger, PixelDiffTrigger |
| 采集器 | 屏幕截图 | ScreenCapture |
| 脱敏器 | 隐私保护 | FaceBlur, TextEncrypt |
| 存储器 | 本地缓存 | UploadQueue |
| 上传器 | 网络传输 | HttpUploader |

### 服务端模块

| 模块 | 职责 | 关键类/文件 |
|------|------|-------------|
| API服务 | HTTP接口 | api.ts |
| 解析器 | 飞书消息处理 | feishu-parser.ts |
| 存储引擎 | 数据持久化 | buffer.ts, query.ts |
| 任务调度 | 定时任务 | 备份、聚合 |
| 监控系统 | 健康检查 | health.ts, metrics.ts |

---

## 安全架构

```
┌─────────────────────────────────────────┐
│              传输层安全                   │
│         TLS 1.3 + Certificate Pinning   │
└─────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────┐
│              认证层                      │
│         API Key + HMAC签名              │
└─────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────┐
│              应用层安全                   │
│    输入验证 + 限流 + SQL注入防护         │
└─────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────┐
│              数据层安全                   │
│    AES-256加密 + 字段级脱敏              │
└─────────────────────────────────────────┘
```

---

## 部署架构

### 单机部署

```
[单台服务器]
    ├── Nginx (反向代理)
    ├── Kimiclaw DB (Docker)
    └── DuckDB (本地文件)
```

### 集群部署

```
[负载均衡] ──► [Node 1] ──┐
              [Node 2] ──┼──► [共享存储]
              [Node 3] ──┘
```

---

## 扩展性设计

### 水平扩展

- 无状态服务设计
- 共享存储（NFS/S3）
- 负载均衡分发

### 垂直扩展

- DuckDB分区表
- 读写分离
- 缓存层（Redis）

---

## 监控设计

| 层级 | 指标 | 告警 |
|------|------|------|
| 系统 | CPU/内存/磁盘 | > 80% |
| 应用 | QPS/延迟/错误率 | > 阈值 |
| 业务 | 采集量/会话数 | 异常波动 |

---

## 技术选型理由

| 技术 | 理由 |
|------|------|
| DuckDB | 高性能分析型数据库，单节点足够 |
| TypeScript | 类型安全，维护性好 |
| Electron | 跨平台，开发效率高 |
| Docker | 部署标准化，环境一致 |