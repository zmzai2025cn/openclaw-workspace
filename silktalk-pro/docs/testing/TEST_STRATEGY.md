# SilkTalk Pro 测试策略文档

## 1. 测试体系概览

### 1.1 测试金字塔

```
        /\
       /  \      E2E 测试 (5%)
      /----\
     /      \    集成测试 (15%)
    /--------\
   /          \  单元测试 (30%)
  /------------\
 /              \ 混沌/模糊/性能测试 (50%)
/----------------\
```

### 1.2 测试分类

| 测试类型 | 目的 | 执行频率 | 位置 |
|---------|------|---------|------|
| 单元测试 | 验证单个模块功能 | 每次提交 | `tests/unit/` |
| 集成测试 | 验证模块间协作 | 每次 PR | `tests/integration/` |
| E2E 测试 | 验证端到端场景 | 每日构建 | `tests/e2e/` |
| 环境测试 | 验证跨平台兼容性 | 每周 | `tests/environment/` |
| 性能测试 | 验证性能基线 | 每次发布 | `tests/performance/` |
| 混沌测试 | 验证系统韧性 | 每周 | `tests/chaos/` |
| 模糊测试 | 发现边界缺陷 | 持续 | `tests/fuzzing/` |
| 安全测试 | 验证安全防护 | 每次发布 | `tests/security/` |

## 2. 环境测试策略

### 2.1 跨平台矩阵

| OS | Node.js 18 | Node.js 20 | Node.js 22 |
|---|------------|------------|------------|
| Ubuntu 22.04 | ✅ | ✅ | ✅ |
| CentOS 8 | ✅ | ✅ | ✅ |
| macOS 14 | ✅ | ✅ | ✅ |
| Windows 11 (WSL) | ✅ | ✅ | ✅ |

### 2.2 网络环境测试

- **局域网**: mDNS 发现、直接连接
- **公网**: DHT 发现、NAT 穿透
- **NAT 后**: UPnP、AutoNAT、Relay
- **防火墙后**: 端口限制、协议限制

## 3. 性能测试策略

### 3.1 性能指标

| 指标 | 目标值 | 警告阈值 | 错误阈值 |
|-----|-------|---------|---------|
| 消息延迟 (P99) | < 100ms | 200ms | 500ms |
| 吞吐量 | > 1000 msg/s | 800 msg/s | 500 msg/s |
| 内存使用 | < 200MB | 300MB | 500MB |
| CPU 使用 | < 50% | 70% | 90% |
| 连接建立时间 | < 5s | 10s | 30s |

### 3.2 负载模型

- **正常负载**: 10 个并发连接，100 msg/s
- **峰值负载**: 100 个并发连接，1000 msg/s
- **压力负载**: 500 个并发连接，5000 msg/s
- **极限负载**: 1000 个并发连接，10000 msg/s

## 4. 混沌工程策略

### 4.1 故障注入类型

| 故障类型 | 注入方式 | 影响范围 | 恢复验证 |
|---------|---------|---------|---------|
| 网络延迟 | tc/netem | 单节点 | 自动恢复 |
| 丢包 | tc/netem | 单节点 | 自动恢复 |
| 分区 | iptables | 节点间 | 手动恢复 |
| 服务宕机 | kill -9 | 单节点 | 手动重启 |
| 内存压力 | stress-ng | 单节点 | 自动恢复 |

### 4.2 韧性指标

- **可用性**: > 99.9%
- **恢复时间 (RTO)**: < 30s
- **恢复点 (RPO)**: 0 (无数据丢失)
- **降级能力**: 核心功能可用

## 5. 模糊测试策略

### 5.1 模糊目标

- 消息解析器
- 协议处理器
- 配置解析器
- 网络包处理器

### 5.2 模糊策略

- **随机模糊**: 完全随机输入
- **结构化模糊**: 基于语法的变异
- **覆盖率引导**: 基于代码覆盖的变异

## 6. CI/CD 集成

### 6.1 流水线阶段

```
代码提交
    │
    ▼
┌─────────────┐
│  快速检查    │  lint, typecheck (2 min)
└─────────────┘
    │
    ▼
┌─────────────┐
│  单元测试    │  tests/unit (5 min)
└─────────────┘
    │
    ▼
┌─────────────┐
│  集成测试    │  tests/integration (10 min)
└─────────────┘
    │
    ▼
┌─────────────┐
│  覆盖率检查  │  > 80% (2 min)
└─────────────┘
    │
    ▼
┌─────────────┐
│  构建验证    │  docker build (5 min)
└─────────────┘
    │
    ▼
合并到 main
    │
    ▼
┌─────────────┐
│  E2E 测试    │  tests/e2e (15 min)
└─────────────┘
    │
    ▼
┌─────────────┐
│  性能测试    │  tests/performance (30 min)
└─────────────┘
    │
    ▼
发布
```

### 6.2 质量门禁

| 检查项 | 阈值 | 失败策略 |
|-------|------|---------|
| 单元测试覆盖率 | > 80% | 阻止合并 |
| 集成测试通过率 | 100% | 阻止合并 |
| 性能回归 | < 10% | 警告 |
| 安全漏洞 | 0 高危 | 阻止发布 |

## 7. 缺陷管理

### 7.1 缺陷分级

| 级别 | 定义 | 响应时间 | 修复时间 |
|-----|------|---------|---------|
| P0 | 系统崩溃/数据丢失 | 1 小时 | 4 小时 |
| P1 | 核心功能不可用 | 4 小时 | 24 小时 |
| P2 | 功能缺陷/性能问题 | 24 小时 | 1 周 |
| P3 | 轻微问题/优化 | 1 周 | 下个版本 |

### 7.2 缺陷记录

所有缺陷记录在 `docs/bug-knowledge/` 目录：
- `history.md`: 历史缺陷记录
- `rca/`: 根因分析报告
- `prevention.md`: 预防措施清单

## 8. 测试执行手册

### 8.1 本地执行

```bash
# 快速检查
npm run lint
npm run typecheck

# 单元测试
npm run test:unit

# 集成测试
npm run test:integration

# E2E 测试
npm run test:e2e

# 性能测试
npm run test:performance

# 混沌测试
npm run test:chaos

# 模糊测试
npm run test:fuzzing

# 全部测试
npm test
```

### 8.2 Docker 环境

```bash
# 构建测试环境
docker-compose -f docker/docker-compose.test.yml build

# 运行环境测试
docker-compose -f docker/docker-compose.test.yml run --rm environment-test

# 运行性能测试
docker-compose -f docker/docker-compose.test.yml run --rm performance-test

# 运行混沌测试
docker-compose -f docker/docker-compose.test.yml run --rm chaos-test
```

## 9. 监控与告警

### 9.1 测试指标

- 测试执行时间
- 测试通过率
- 代码覆盖率
- 性能指标趋势
- 缺陷密度

### 9.2 告警规则

- 测试失败率 > 5%
- 覆盖率下降 > 5%
- 性能回归 > 20%
- 新增高危漏洞

## 10. 持续改进

### 10.1 定期审查

- 每周: 测试失败分析
- 每月: 覆盖率审查
- 每季度: 测试策略回顾

### 10.2 改进流程

1. 识别测试缺口
2. 制定改进计划
3. 实施改进
4. 验证效果
5. 文档更新
