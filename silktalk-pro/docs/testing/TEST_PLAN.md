# 测试计划
## Test Plan

**文档编号**: STP-TP-001  
**版本**: 1.0.0  
**日期**: 2026-02-22  
**状态**: 已批准  
**作者**: SilkTalk Pro QA 团队  
**审核人**: 待签字  

---

## 1. 引言

### 1.1 目的
本文档定义 SilkTalk Pro 项目的测试策略、测试范围和测试计划。

### 1.2 范围
涵盖单元测试、集成测试、E2E 测试、性能测试和安全测试。

### 1.3 参考资料
- STP-SRS-001 需求规格说明书
- STP-HLD-001 概要设计文档
- IEEE 829-2008 测试文档标准

---

## 2. 测试策略

### 2.1 测试级别

```
┌─────────────────────────────────────────┐
│           E2E Tests                      │
│    (Real network, real nodes)           │
├─────────────────────────────────────────┤
│        Integration Tests                 │
│  (Multiple components, mocked network)  │
├─────────────────────────────────────────┤
│          Unit Tests                      │
│     (Individual components)             │
└─────────────────────────────────────────┘
```

### 2.2 测试类型

| 测试类型 | 目标 | 工具 | 覆盖率目标 |
|----------|------|------|------------|
| 单元测试 | 验证单个函数/类 | Vitest | > 90% |
| 集成测试 | 验证组件交互 | Vitest | > 80% |
| E2E 测试 | 验证端到端流程 | Vitest + 真实网络 | 关键路径 |
| 性能测试 | 验证性能指标 | Benchmark.js | 基准测试 |
| 安全测试 | 验证安全机制 | 自定义工具 | 安全需求 |

### 2.3 测试环境

#### 2.3.1 开发环境
- Node.js 20.x
- TypeScript 5.x
- Vitest 1.x

#### 2.3.2 CI 环境
- GitHub Actions
- Ubuntu 22.04
- Node.js 18, 20

#### 2.3.3 测试网络
- 本地网络 (mDNS)
- 模拟 NAT 环境
- 公共 DHT 网络 (测试时)

---

## 3. 测试范围

### 3.1 单元测试范围

#### 3.1.1 Core 模块
| 组件 | 测试项 | 优先级 |
|------|--------|--------|
| SilkNode | 生命周期、事件、消息发送 | 高 |
| IdentityManager | 密钥生成、加载、导出 | 高 |
| ConfigManager | 配置加载、合并、保存 | 高 |
| Logger | 日志级别、格式化 | 中 |

#### 3.1.2 Network 模块
| 组件 | 测试项 | 优先级 |
|------|--------|--------|
| ConnectionManager | 连接池、清理、统计 | 高 |
| TransportManager | 传输选择、地址管理 | 中 |
| NatTraversal | NAT 检测、策略 | 中 |

#### 3.1.3 Protocol 模块
| 组件 | 测试项 | 优先级 |
|------|--------|--------|
| MessageHandler | 编码、解码、验证 | 高 |

#### 3.1.4 Routing 模块
| 组件 | 测试项 | 优先级 |
|------|--------|--------|
| PeerDiscovery | 对等点管理、发现 | 中 |
| DHTRouting | 存储、检索、清理 | 中 |

### 3.2 集成测试范围

| 场景 | 描述 | 优先级 |
|------|------|--------|
| 多传输通信 | TCP <-> WebSocket | 高 |
| NAT 穿透 | 不同 NAT 类型 | 高 |
| DHT 发现 | 对等点发现 | 中 |
| 中继连接 | 中继 fallback | 高 |

### 3.3 E2E 测试范围

| 场景 | 描述 | 优先级 |
|------|------|--------|
| 本地网络通信 | mDNS 发现 + 消息传递 | 高 |
| NAT 环境通信 | 穿透受限网络 | 高 |
| CLI 操作 | 完整命令流程 | 中 |
| 长时间运行 | 稳定性测试 | 中 |

---

## 4. 测试用例设计

### 4.1 单元测试用例

#### TC-NODE-001: 节点启动
**前置条件**: 无
**输入**: 默认配置
**步骤**:
1. 创建 SilkNode 实例
2. 调用 start()
**预期结果**:
- 节点状态为 started
- libp2p 节点已创建
- 监听地址已分配

#### TC-NODE-002: 重复启动
**前置条件**: 节点已启动
**输入**: 无
**步骤**:
1. 调用 start() 再次
**预期结果**:
- 返回警告日志
- 不抛出错误

#### TC-NODE-003: 节点停止
**前置条件**: 节点已启动
**输入**: 无
**步骤**:
1. 调用 stop()
**预期结果**:
- 节点状态为 stopped
- 所有连接已关闭
- libp2p 节点已停止

#### TC-ID-001: 身份生成
**前置条件**: 无
**输入**: 无
**步骤**:
1. 调用 createNewIdentity()
**预期结果**:
- 返回有效的 PeerId
- 私钥已保存到文件
- 文件权限为 600

#### TC-ID-002: 身份加载
**前置条件**: 身份文件存在
**输入**: 无
**步骤**:
1. 调用 loadOrCreate()
**预期结果**:
- 返回与之前相同的 PeerId
- 私钥已加载

#### TC-CFG-001: 配置加载
**前置条件**: 配置文件存在
**输入**: 配置文件路径
**步骤**:
1. 调用 load()
**预期结果**:
- 返回配置对象
- 默认值已合并

#### TC-CFG-002: 配置优先级
**前置条件**: 配置文件和环境变量都存在
**输入**: 环境变量覆盖值
**步骤**:
1. 加载配置
2. 检查环境变量值
**预期结果**:
- 环境变量值优先于配置文件

#### TC-MSG-001: 消息编码
**前置条件**: 无
**输入**: SilkMessage 对象
**步骤**:
1. 调用 encodeMessage()
**预期结果**:
- 返回 Uint8Array
- 格式为 JSON

#### TC-MSG-002: 消息解码
**前置条件**: 无
**输入**: 编码后的消息
**步骤**:
1. 调用 decodeMessage()
**预期结果**:
- 返回原始 SilkMessage
- 所有字段正确

#### TC-MSG-003: 消息验证 - 有效消息
**前置条件**: 无
**输入**: 有效消息
**步骤**:
1. 调用 validateMessage()
**预期结果**:
- 不抛出错误

#### TC-MSG-004: 消息验证 - 无效版本
**前置条件**: 无
**输入**: 版本为 999 的消息
**步骤**:
1. 调用 validateMessage()
**预期结果**:
- 抛出 ValidationError

#### TC-MSG-005: 消息验证 - 过期时间戳
**前置条件**: 无
**输入**: 时间戳为 1 小时前的消息
**步骤**:
1. 调用 validateMessage()
**预期结果**:
- 抛出 ValidationError

#### TC-CONN-001: 添加连接
**前置条件**: 无
**输入**: PeerId 和 Connection 对象
**步骤**:
1. 调用 addConnection()
**预期结果**:
- 连接已添加到池
- 事件已触发

#### TC-CONN-002: 连接数限制
**前置条件**: 已达到最大连接数
**输入**: 新连接请求
**步骤**:
1. 调用 addConnection()
**预期结果**:
- 最老的连接被关闭
- 新连接被添加

#### TC-CONN-003: 空闲连接清理
**前置条件**: 有长时间未活动的连接
**输入**: 无
**步骤**:
1. 调用 pruneConnections()
**预期结果**:
- 空闲连接被关闭
- 活跃连接保留

### 4.2 集成测试用例

#### TC-INT-001: TCP 到 TCP 通信
**前置条件**: 两个节点配置 TCP 传输
**输入**: 消息
**步骤**:
1. 启动节点 A
2. 启动节点 B
3. 节点 A 连接到节点 B
4. 节点 A 发送消息
**预期结果**:
- 节点 B 收到消息
- 消息内容正确

#### TC-INT-002: TCP 到 WebSocket 通信
**前置条件**: 节点 A 配置 TCP，节点 B 配置 WebSocket
**输入**: 消息
**步骤**:
1. 启动节点 A 和 B
2. 节点 A 连接到节点 B
3. 发送消息
**预期结果**:
- 消息成功传递

#### TC-INT-003: 中继 Fallback
**前置条件**: 节点在 Symmetric NAT 后
**输入**: 消息
**步骤**:
1. 启动中继节点
2. 启动 NAT 后的节点
3. 尝试直接连接（失败）
4. 通过中继连接
5. 发送消息
**预期结果**:
- 使用中继连接成功
- 消息传递成功

#### TC-INT-004: DHT 存储和检索
**前置条件**: DHT 网络可用
**输入**: 键值对
**步骤**:
1. 存储值到 DHT
2. 从 DHT 检索
**预期结果**:
- 检索值与存储值一致

### 4.3 E2E 测试用例

#### TC-E2E-001: 完整消息流程
**前置条件**: 本地网络环境
**输入**: 文本消息
**步骤**:
1. 启动节点 A
2. 启动节点 B
3. 等待 mDNS 发现
4. 节点 A 发送消息到节点 B
5. 节点 B 回复消息
**预期结果**:
- 双向消息传递成功
- 消息顺序正确

#### TC-E2E-002: CLI 启动和连接
**前置条件**: 已安装 CLI
**输入**: 命令行参数
**步骤**:
1. 执行 `silktalk start --port 4001`
2. 执行 `silktalk connect /ip4/127.0.0.1/tcp/4001/p2p/...`
**预期结果**:
- 节点启动成功
- 连接建立成功

#### TC-E2E-003: 长时间运行稳定性
**前置条件**: 节点已启动
**输入**: 持续消息流
**步骤**:
1. 启动节点
2. 持续发送消息 1 小时
3. 监控内存和连接
**预期结果**:
- 无内存泄漏
- 连接保持稳定

---

## 5. 测试执行计划

### 5.1 测试阶段

| 阶段 | 时间 | 活动 | 产出 |
|------|------|------|------|
| 单元测试 | 持续 | 开发人员编写和执行 | 测试报告 |
| 集成测试 | 每周 | CI 自动执行 | 测试报告 |
| E2E 测试 | 发布前 | QA 执行 | 测试报告 |
| 性能测试 | 发布前 | 性能团队执行 | 基准报告 |
| 安全测试 | 发布前 | 安全团队执行 | 安全报告 |

### 5.2 CI/CD 集成

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run test:unit -- --coverage
      - uses: codecov/codecov-action@v3
        with:
          fail_ci_if_error: true
          verbose: true

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run test:integration

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run test:e2e
```

### 5.3 测试覆盖率要求

| 模块 | 行覆盖率 | 分支覆盖率 | 函数覆盖率 |
|------|----------|------------|------------|
| Core | >= 90% | >= 85% | >= 95% |
| Network | >= 85% | >= 80% | >= 90% |
| Protocol | >= 90% | >= 85% | >= 95% |
| Routing | >= 85% | >= 80% | >= 90% |
| Bridge | >= 80% | >= 75% | >= 85% |

---

## 6. 缺陷管理

### 6.1 缺陷严重级别

| 级别 | 定义 | 响应时间 | 修复时间 |
|------|------|----------|----------|
| P0 - 阻塞 | 系统无法运行 | 立即 | 4 小时 |
| P1 - 严重 | 主要功能失效 | 2 小时 | 24 小时 |
| P2 - 一般 | 次要功能问题 | 24 小时 | 1 周 |
| P3 - 轻微 | 界面/文档问题 | 1 周 | 下次发布 |

### 6.2 缺陷跟踪流程
```
发现 → 记录 → 分类 → 分配 → 修复 → 验证 → 关闭
```

---

## 7. 测试交付物

### 7.1 测试文档
- 测试计划 (本文档)
- 测试用例文档
- 测试报告

### 7.2 测试代码
- 单元测试代码
- 集成测试代码
- E2E 测试代码
- 测试工具脚本

### 7.3 测试报告内容
- 测试执行摘要
- 覆盖率报告
- 缺陷统计
- 风险评估
- 发布建议

---

## 8. 附录

### 8.1 测试工具

| 工具 | 用途 | 版本 |
|------|------|------|
| Vitest | 测试框架 | ^1.0.0 |
| @vitest/coverage-v8 | 覆盖率 | ^1.0.0 |
| Benchmark.js | 性能测试 | ^2.1.4 |
| Sinon | Mock/Stub | ^17.0.0 |

### 8.2 变更历史

| 版本 | 日期 | 作者 | 变更描述 |
|------|------|------|----------|
| 1.0.0 | 2026-02-22 | SilkTalk QA | 初始版本 |

### 8.3 批准签字

**QA 负责人**: _________________ 日期: _______

**开发负责人**: _________________ 日期: _______

**项目经理**: _________________ 日期: _______

---

**文档结束**
