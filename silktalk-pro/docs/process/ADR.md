# 架构决策记录 (ADR)
## Architecture Decision Records

**文档编号**: STP-ADR-001  
**版本**: 1.0.0  
**日期**: 2026-02-22  
**状态**: 已批准  
**作者**: SilkTalk Pro 架构团队  
**审核人**: 待签字  

---

## ADR-001: 使用 libp2p 作为 P2P 网络栈

### 状态
已接受

### 背景
需要选择一个 P2P 网络栈来实现 SilkTalk Pro 的核心功能。

### 决策
使用 libp2p 作为 P2P 网络栈。

### 原因
1. **成熟度**: libp2p 是 IPFS 的核心组件，经过大规模验证
2. **模块化**: 支持按需选择传输、加密、发现等模块
3. **生态**: 丰富的协议实现和社区支持
4. **跨平台**: 支持多种语言和平台

### 替代方案
- **WebRTC**: 更适合浏览器环境，缺少 DHT 等功能
- **Hyperswarm**: 较新，生态不如 libp2p 成熟
- **自研**: 开发成本高，维护负担重

### 影响
- 依赖 libp2p 的发布周期
- 需要学习 libp2p 的概念和 API

### 相关决策
- ADR-002: 传输协议选择
- ADR-003: 加密协议选择

---

## ADR-002: 传输协议选择

### 状态
已接受

### 背景
需要选择合适的传输协议来支持不同的网络环境。

### 决策
同时支持 TCP 和 WebSocket 传输。

### 原因
1. **TCP**: 性能最佳，适合直接连接
2. **WebSocket**: 防火墙友好，适合受限网络
3. **互补**: 两种协议覆盖不同场景

### 配置
- 默认启用 TCP
- WebSocket 可选启用
- 自动选择最优传输

### 影响
- 增加代码复杂度
- 需要处理协议协商

---

## ADR-003: 使用 Noise 协议进行加密

### 状态
已接受

### 背景
需要选择传输层加密协议。

### 决策
使用 Noise Protocol (XX 握手模式)。

### 原因
1. **安全性**: 现代加密协议，经过形式化验证
2. **性能**: 比 TLS 更轻量
3. **P2P 友好**: 无需证书基础设施
4. **libp2p 默认**: 与 libp2p 生态一致

### 替代方案
- **TLS**: 需要证书管理，不适合 P2P
- **DTLS**: 主要用于 UDP

### 影响
- 无法与使用 TLS 的系统直接互操作

---

## ADR-004: 使用 Kademlia DHT

### 状态
已接受

### 背景
需要选择对等点发现和内容路由机制。

### 决策
使用 Kademlia DHT 协议。

### 原因
1. **成熟**: 经过 BitTorrent 等大规模验证
2. **效率**: O(log n) 查找复杂度
3. **libp2p 支持**: 有成熟的实现
4. **功能**: 支持对等点路由和内容路由

### 配置
- K = 20
- Alpha = 3
- 刷新间隔: 1 小时

### 替代方案
- **Chord**: 复杂度相似，但 Kademlia 更流行
- **Pastry**: 类似，但 Kademlia 生态更好

---

## ADR-005: 消息序列化格式

### 状态
已接受

### 背景
需要选择消息序列化格式。

### 决策
使用 JSON 作为消息序列化格式。

### 原因
1. **可读性**: 便于调试
2. **兼容性**: 广泛支持
3. **开发效率**: 无需定义 schema
4. **TypeScript 友好**: 原生支持

### 替代方案
- **Protocol Buffers**: 更高效，但需要 schema
- **CBOR**: 二进制 JSON，但不够普及
- **MessagePack**: 类似 CBOR

### 影响
- 消息体积较大
- 解析性能低于二进制格式

### 备注
未来可考虑支持二进制格式作为优化。

---

## ADR-006: 使用 pino 进行日志记录

### 状态
已接受

### 背景
需要选择日志库。

### 决策
使用 pino 作为日志库。

### 原因
1. **性能**: 最快的 Node.js 日志库之一
2. **结构化**: 原生 JSON 输出
3. **生态**: 丰富的生态 (pino-pretty 等)
4. **TypeScript**: 良好支持

### 配置
- 默认级别: info
- 生产环境: JSON 格式
- 开发环境: pretty 格式

### 替代方案
- **Winston**: 更灵活，但性能较低
- **Bunyan**: 类似 pino，但维护较少

---

## ADR-007: 使用 Vitest 进行测试

### 状态
已接受

### 背景
需要选择测试框架。

### 决策
使用 Vitest 作为测试框架。

### 原因
1. **性能**: 基于 Vite，测试速度快
2. **兼容性**: 支持 Jest API
3. **TypeScript**: 原生支持
4. **生态**: 内置覆盖率、mock 等功能

### 配置
- 单元测试: 并行执行
- 集成测试: 串行执行
- E2E 测试: 单独配置

### 替代方案
- **Jest**: 行业标准，但较慢
- **Mocha**: 灵活，但需要更多配置

---

## ADR-008: 使用 Commander 构建 CLI

### 状态
已接受

### 背景
需要构建命令行接口。

### 决策
使用 Commander.js 构建 CLI。

### 原因
1. **流行**: Node.js CLI 的标准选择
2. **功能**: 自动生成帮助、版本等
3. **TypeScript**: 良好支持
4. **文档**: 丰富的示例

### 替代方案
- **Yargs**: 类似，但 Commander 更轻量
- **Oclif**: 功能丰富，但较重

---

## ADR-009: 项目结构组织

### 状态
已接受

### 背景
需要组织项目代码结构。

### 决策
按功能分层组织：
```
src/
├── core/       # 核心功能 (节点、身份、配置)
├── network/    # 网络层 (连接、传输、NAT)
├── routing/    # 路由层 (DHT、发现)
├── protocol/   # 协议层 (消息处理)
├── bridge/     # 桥接层 (OpenClaw)
└── cli/        # 命令行接口
```

### 原因
1. **关注点分离**: 每层职责清晰
2. **可测试性**: 便于单元测试
3. **可维护性**: 代码易于理解
4. **扩展性**: 便于添加新功能

### 替代方案
- **按类型组织**: 所有控制器、服务等分开
- **按功能组织**: 每个功能一个目录

---

## ADR-010: 使用 ESM 模块系统

### 状态
已接受

### 背景
需要选择模块系统。

### 决策
使用 ES Modules (ESM)。

### 原因
1. **标准**: JavaScript 标准模块系统
2. **Tree Shaking**: 更好的打包优化
3. **TypeScript**: 原生支持
4. **未来**: CommonJS 逐渐淘汰

### 配置
```json
{
  "type": "module",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

### 影响
- 部分旧库可能不兼容
- 需要 `.js` 扩展名导入

---

## 附录

### 变更历史

| 版本 | 日期 | 作者 | 变更描述 |
|------|------|------|----------|
| 1.0.0 | 2026-02-22 | SilkTalk Architecture | 初始版本 |

### 批准签字

**架构师**: _________________ 日期: _______

**技术负责人**: _________________ 日期: _______

**项目经理**: _________________ 日期: _______

---

**文档结束**
