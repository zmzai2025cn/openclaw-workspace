#!/bin/bash
#==============================================================================
# 脚本名称: setup-node.sh
# 功能描述: SilkTalk Pro Node.js 安装脚本 - 支持多版本管理、多源安装、自动配置
# 作者: SilkTalk Team
# 版本: 1.0.0
# 日期: 2026-02-22
#==============================================================================
#
# 设计目标:
#   - 多版本支持: 支持 Node.js 16/18/20/22
#   - 多源安装: 官方源、国内镜像、预编译二进制
#   - 自动适配: 根据权限选择安装方式
#   - 版本管理: 可选 nvm/fnm 进行版本管理
#
# 安装方式:
#   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
#   │  二进制安装  │    │   nvm 安装   │    │   fnm 安装   │
#   │  (推荐)     │    │  (版本切换)  │    │  (快速切换)  │
#   └─────────────┘    └─────────────┘    └─────────────┘
#          │
#          v
#   ┌─────────────┐
#   │  用户级安装  │
#   │ (无 root)   │
#   └─────────────┘
#
# 使用方法:
#   ./setup-node.sh [选项]
#
# 选项:
#   --version <ver>    Node.js 版本 (默认: 20)
#   --prefix <path>   安装前缀 (默认: /usr/local)
#   --mirror <source>  镜像源: auto|cn|global (默认: auto)
#   --force            强制重新安装
#   --verbose          详细输出
#
# 返回值:
#   0 - 安装成功
#   1 - 安装失败
#
# 示例:
#   # 安装默认版本 (Node.js 20)
#   ./setup-node.sh
#
#   # 安装指定版本
#   ./setup-node.sh --version 18
#
#   # 使用国内镜像
#   ./setup-node.sh --mirror cn
#
#   # 用户级安装
#   ./setup-node.sh --prefix ~/.local
#
#==============================================================================

#------------------------------------------------------------------------------
# 严格模式设置
#------------------------------------------------------------------------------
set -euo pipefail

#------------------------------------------------------------------------------
# 全局配置
#------------------------------------------------------------------------------
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# 命令行参数
NODE_VERSION="20"
INSTALL_PREFIX="/usr/local"
USE_MIRROR="auto"
FORCE_REINSTALL=false
VERBOSE=false

#------------------------------------------------------------------------------
# 颜色定义
#------------------------------------------------------------------------------
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

#------------------------------------------------------------------------------
# 日志函数
#------------------------------------------------------------------------------
log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }
log_success() { echo -e "${GREEN}[PASS]${NC} $*"; }

#------------------------------------------------------------------------------
# 参数解析
#------------------------------------------------------------------------------
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version) NODE_VERSION="$2"; shift 2 ;;
            --prefix) INSTALL_PREFIX="$2"; shift 2 ;;
            --mirror) USE_MIRROR="$2"; shift 2 ;;
            --force) FORCE_REINSTALL=true; shift ;;
            --verbose) VERBOSE=true; shift ;;
            *) shift ;;
        esac
    done
}

#------------------------------------------------------------------------------
# 权限获取
#------------------------------------------------------------------------------

#==============================================================================
# 函数: get_sudo
# 描述: 获取 sudo 命令前缀
# 参数: 无
# 返回值: "" (root) 或 "sudo" (需提权)
#==============================================================================
get_sudo() {
    if [[ $EUID -eq 0 ]]; then
        echo ""
    elif command -v sudo &> /dev/null; then
        echo "sudo"
    else
        echo ""
    fi
}

#------------------------------------------------------------------------------
# Node.js 检测
#------------------------------------------------------------------------------

#==============================================================================
# 函数: check_current_node
# 描述: 检测当前安装的 Node.js 主版本号
# 参数: 无
# 返回值: Node.js 主版本号 (如 20)，未安装返回 0
#==============================================================================
check_current_node() {
    if command -v node &> /dev/null; then
        local version
        version=$(node --version | sed 's/v//')
        local major
        major=$(echo "$version" | cut -d. -f1)
        echo "$major"
    else
        echo "0"
    fi
}

#------------------------------------------------------------------------------
# 下载 URL 生成
#------------------------------------------------------------------------------

#==============================================================================
# 函数: get_node_download_url
# 描述: 根据版本和架构生成 Node.js 下载 URL
# 参数:
#   $1 - Node.js 版本号 (如 20.11.0 或 v20.11.0)
# 返回值: 完整的下载 URL
# URL 格式:
#   官方: https://nodejs.org/dist/v{version}/node-v{version}-{platform}-{arch}.tar.xz
#   国内: https://npmmirror.com/mirrors/node/v{version}/node-v{version}-{platform}-{arch}.tar.xz
#==============================================================================
get_node_download_url() {
    local version="$1"
    local arch
    arch=$(uname -m)
    local platform="linux"
    
    #------------------------------------------------------------------------------
    # 架构映射
    #------------------------------------------------------------------------------
    case "$arch" in
        x86_64) arch="x64" ;;
        aarch64) arch="arm64" ;;
        armv7l) arch="armv7l" ;;
    esac
    
    #------------------------------------------------------------------------------
    # 确保版本号有 v 前缀
    #------------------------------------------------------------------------------
    if [[ ! "$version" =~ ^v ]]; then
        version="v${version}"
    fi
    
    local filename="node-${version}-${platform}-${arch}.tar.xz"
    
    #------------------------------------------------------------------------------
    # 选择镜像源
    #------------------------------------------------------------------------------
    case "$USE_MIRROR" in
        cn)
            echo "https://npmmirror.com/mirrors/node/${version}/${filename}"
            ;;
        *)
            echo "https://nodejs.org/dist/${version}/${filename}"
            ;;
    esac
}

#------------------------------------------------------------------------------
# 安装方法
#------------------------------------------------------------------------------

#==============================================================================
# 函数: install_node_binary
# 描述: 从预编译二进制包安装 Node.js
# 参数:
#   $1 - Node.js 版本号
# 返回值: 0=成功, 1=失败
# 流程:
#   1. 生成下载 URL
#   2. 下载 tar.xz 包
#   3. 解压到临时目录
#   4. 复制到安装目录
#   5. 清理临时文件
# 说明: 这是最推荐的安装方式，速度快且稳定
#==============================================================================
install_node_binary() {
    local version="$1"
    local sudo_cmd
    sudo_cmd=$(get_sudo)
    
    log_info "下载 Node.js ${version}..."
    
    #------------------------------------------------------------------------------
    # 生成下载 URL
    #------------------------------------------------------------------------------
    local download_url
    download_url=$(get_node_download_url "$version")
    local temp_dir
    temp_dir=$(mktemp -d)
    local filename
    filename=$(basename "$download_url")
    
    log_info "下载地址: $download_url"
    
    #------------------------------------------------------------------------------
    # 下载
    #------------------------------------------------------------------------------
    # --progress-bar: 显示进度条
    # -fsSL: 静默模式，跟随重定向，失败时显示错误
    if ! curl -fsSL --progress-bar "$download_url" -o "${temp_dir}/${filename}"; then
        log_error "下载失败: $download_url"
        rm -rf "$temp_dir"
        return 1
    fi
    
    #------------------------------------------------------------------------------
    # 解压
    #------------------------------------------------------------------------------
    log_info "解压..."
    tar -xf "${temp_dir}/${filename}" -C "$temp_dir"
    
    # 获取解压后的目录名
    local extracted_dir="${temp_dir}/node-$(echo "$version" | sed 's/^v//')-$(uname -s | tr '[:upper:]' '[:lower:]')-$(uname -m | sed 's/x86_64/x64/;s/aarch64/arm64/')"
    
    #------------------------------------------------------------------------------
    # 安装到目标目录
    #------------------------------------------------------------------------------
    log_info "安装到 ${INSTALL_PREFIX}..."
    if [[ -n "$sudo_cmd" ]]; then
        # 使用 sudo 安装
        $sudo_cmd rm -rf "${INSTALL_PREFIX}/node" 2>/dev/null || true
        $sudo_cmd mkdir -p "$INSTALL_PREFIX"
        $sudo_cmd cp -r "${extracted_dir}/"* "$INSTALL_PREFIX/"
    else
        # 直接安装（root 或用户级）
        rm -rf "${INSTALL_PREFIX}/node" 2>/dev/null || true
        mkdir -p "$INSTALL_PREFIX"
        cp -r "${extracted_dir}/"* "$INSTALL_PREFIX/"
    fi
    
    #------------------------------------------------------------------------------
    # 清理
    #------------------------------------------------------------------------------
    rm -rf "$temp_dir"
    
    log_success "Node.js ${version} 安装完成"
}

#==============================================================================
# 函数: install_node_nvm
# 描述: 使用 nvm (Node Version Manager) 安装 Node.js
# 参数:
#   $1 - Node.js 版本号
# 返回值: 0=成功
# 说明:
#   - nvm 适合需要频繁切换 Node.js 版本的场景
#   - 安装到用户目录，无需 root 权限
#   - 支持 .nvmrc 文件自动切换版本
#==============================================================================
install_node_nvm() {
    local version="$1"
    
    log_info "使用 nvm 安装 Node.js ${version}..."
    
    #------------------------------------------------------------------------------
    # 安装 nvm
    #------------------------------------------------------------------------------
    if [[ ! -d "$HOME/.nvm" ]]; then
        log_info "安装 nvm..."
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
        export NVM_DIR="$HOME/.nvm"
        # shellcheck source=/dev/null
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    fi
    
    #------------------------------------------------------------------------------
    # 加载 nvm
    #------------------------------------------------------------------------------
    export NVM_DIR="$HOME/.nvm"
    # shellcheck source=/dev/null
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
    
    #------------------------------------------------------------------------------
    # 配置镜像
    #------------------------------------------------------------------------------
    if [[ "$USE_MIRROR" == "cn" ]]; then
        export NVM_NODEJS_ORG_MIRROR=https://npmmirror.com/mirrors/node
    fi
    
    #------------------------------------------------------------------------------
    # 安装 Node.js
    #------------------------------------------------------------------------------
    nvm install "$version"
    nvm use "$version"
    nvm alias default "$version"
    
    log_success "Node.js ${version} 安装完成 (via nvm)"
}

#==============================================================================
# 函数: install_node_fnm
# 描述: 使用 fnm (Fast Node Manager) 安装 Node.js
# 参数:
#   $1 - Node.js 版本号
# 返回值: 0=成功
# 说明:
#   - fnm 是用 Rust 编写的，速度比 nvm 更快
#   - 支持自动版本切换（基于 .node-version 或 .nvmrc）
#==============================================================================
install_node_fnm() {
    local version="$1"
    
    log_info "使用 fnm 安装 Node.js ${version}..."
    
    #------------------------------------------------------------------------------
    # 安装 fnm
    #------------------------------------------------------------------------------
    if ! command -v fnm &> /dev/null; then
        log_info "安装 fnm..."
        curl -fsSL https://fnm.vercel.app/install | bash
        export PATH="$HOME/.local/share/fnm:$PATH"
        eval "$(fnm env)"
    fi
    
    #------------------------------------------------------------------------------
    # 配置镜像
    #------------------------------------------------------------------------------
    if [[ "$USE_MIRROR" == "cn" ]]; then
        export FNM_NODE_DIST_MIRROR=https://npmmirror.com/mirrors/node
    fi
    
    #------------------------------------------------------------------------------
    # 安装 Node.js
    #------------------------------------------------------------------------------
    fnm install "$version"
    fnm use "$version"
    fnm default "$version"
    
    log_success "Node.js ${version} 安装完成 (via fnm)"
}

#==============================================================================
# 函数: install_node_user
# 描述: 用户级安装 Node.js（无 root 权限时使用）
# 参数:
#   $1 - Node.js 版本号
# 返回值: 0=成功
# 说明:
#   - 安装到 ~/.local
#   - 自动配置 PATH
#   - 仅复制必要的二进制文件
#==============================================================================
install_node_user() {
    local version="$1"
    
    log_warn "使用用户级安装..."
    
    local user_prefix="$HOME/.local"
    mkdir -p "$user_prefix/bin"
    
    #------------------------------------------------------------------------------
    # 下载并解压
    #------------------------------------------------------------------------------
    local download_url
    download_url=$(get_node_download_url "$version")
    local temp_dir
    temp_dir=$(mktemp -d)
    local filename
    filename=$(basename "$download_url")
    
    log_info "下载 Node.js ${version}..."
    curl -fsSL --progress-bar "$download_url" -o "${temp_dir}/${filename}"
    
    log_info "解压到 ${user_prefix}..."
    tar -xf "${temp_dir}/${filename}" -C "$temp_dir"
    
    local extracted_dir
    extracted_dir=$(find "$temp_dir" -maxdepth 1 -type d -name "node-*" | head -1)
    
    #------------------------------------------------------------------------------
    # 复制文件到用户目录
    #------------------------------------------------------------------------------
    cp -r "${extracted_dir}/bin/"* "$user_prefix/bin/" 2>/dev/null || true
    cp -r "${extracted_dir}/lib/"* "$user_prefix/lib/" 2>/dev/null || true
    cp -r "${extracted_dir}/include/"* "$user_prefix/include/" 2>/dev/null || true
    cp -r "${extracted_dir}/share/"* "$user_prefix/share/" 2>/dev/null || true
    
    rm -rf "$temp_dir"
    
    #------------------------------------------------------------------------------
    # 配置 PATH
    #------------------------------------------------------------------------------
    if [[ ":$PATH:" != *":$user_prefix/bin:"* ]]; then
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
        export PATH="$user_prefix/bin:$PATH"
    fi
    
    log_success "Node.js ${version} 安装完成 (用户级)"
}

#------------------------------------------------------------------------------
# npm 配置
#------------------------------------------------------------------------------

#==============================================================================
# 函数: configure_npm
# 描述: 配置 npm 镜像源和全局安装路径
# 参数: 无
# 返回值: 0=成功
# 配置项:
#   - registry: npm 镜像源
#   - prefix: 全局安装路径（用户级）
#   - PATH: 添加全局包到 PATH
#==============================================================================
configure_npm() {
    log_info "配置 npm..."
    
    #------------------------------------------------------------------------------
    # 配置镜像源
    #------------------------------------------------------------------------------
    if [[ "$USE_MIRROR" == "cn" ]]; then
        log_info "配置中国 npm 镜像..."
        npm config set registry https://registry.npmmirror.com
    fi
    
    #------------------------------------------------------------------------------
    # 配置全局安装路径（非 root 用户）
    #------------------------------------------------------------------------------
    if [[ $EUID -ne 0 ]]; then
        mkdir -p "$HOME/.npm-global"
        npm config set prefix "$HOME/.npm-global"
        
        # 添加到 PATH
        if [[ ":$PATH:" != *":$HOME/.npm-global/bin:"* ]]; then
            echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> "$HOME/.bashrc"
            export PATH="$HOME/.npm-global/bin:$PATH"
        fi
    fi
    
    log_success "npm 配置完成"
}

#------------------------------------------------------------------------------
# 安装验证
#------------------------------------------------------------------------------

#==============================================================================
# 函数: verify_installation
# 描述: 验证 Node.js 和 npm 安装
# 参数: 无
# 返回值:
#   0 - 验证通过
#   1 - 验证失败
# 验证项:
#   - node 命令可用
#   - npm 命令可用
#   - Node.js 版本 >= 18
#==============================================================================
verify_installation() {
    log_info "验证 Node.js 安装..."
    
    #------------------------------------------------------------------------------
    # 检查 Node.js
    #------------------------------------------------------------------------------
    if ! command -v node &> /dev/null; then
        log_error "Node.js 未找到"
        return 1
    fi
    
    #------------------------------------------------------------------------------
    # 检查 npm
    #------------------------------------------------------------------------------
    if ! command -v npm &> /dev/null; then
        log_error "npm 未找到"
        return 1
    fi
    
    #------------------------------------------------------------------------------
    # 获取版本信息
    #------------------------------------------------------------------------------
    local node_v
    node_v=$(node --version)
    local npm_v
    npm_v=$(npm --version)
    
    log_info "Node.js: $node_v"
    log_info "npm: v$npm_v"
    
    #------------------------------------------------------------------------------
    # 版本检查
    #------------------------------------------------------------------------------
    local major
    major=$(echo "$node_v" | sed 's/v//' | cut -d. -f1)
    if [[ "$major" -lt 18 ]]; then
        log_warn "Node.js 版本过低 (需要 >= 18)"
        return 1
    fi
    
    log_success "Node.js 安装验证通过"
    return 0
}

#------------------------------------------------------------------------------
# 主函数
#------------------------------------------------------------------------------

#==============================================================================
# 函数: main
# 描述: 脚本入口函数
# 参数: $@ - 所有命令行参数
# 返回值:
#   0 - 安装成功
#   1 - 安装失败
#==============================================================================
main() {
    # 解析命令行参数
    parse_args "$@"
    
    # 输出开始信息
    log_info "=========================================="
    log_info "SilkTalk Pro Node.js 安装"
    log_info "=========================================="
    log_info "目标版本: ${NODE_VERSION}"
    log_info "安装前缀: ${INSTALL_PREFIX}"
    log_info "镜像源: ${USE_MIRROR}"
    
    #------------------------------------------------------------------------------
    # 检查当前版本
    #------------------------------------------------------------------------------
    local current_major
    current_major=$(check_current_node)
    log_info "当前版本: ${current_major}"
    
    #------------------------------------------------------------------------------
    # 检查是否需要安装
    #------------------------------------------------------------------------------
    # 如果已安装且版本满足要求，且非强制重装，则跳过
    if [[ "$FORCE_REINSTALL" == false && "$current_major" -ge "${NODE_VERSION%%.*}" ]]; then
        log_success "Node.js 已满足要求 (v${current_major})"
        configure_npm
        verify_installation
        exit 0
    fi
    
    #------------------------------------------------------------------------------
    # 选择安装方法
    #------------------------------------------------------------------------------
    # 检查权限
    local can_write=false
    if [[ -d "$INSTALL_PREFIX" && -w "$INSTALL_PREFIX" ]] || [[ $EUID -eq 0 ]]; then
        can_write=true
    fi
    
    # 检查 sudo
    local has_sudo=false
    if [[ $EUID -eq 0 ]] || command -v sudo &> /dev/null; then
        has_sudo=true
    fi
    
    # 决定安装方法
    if [[ "$can_write" == false && "$has_sudo" == false ]]; then
        # 无权限，使用用户级安装
        install_node_user "$NODE_VERSION"
    else
        # 有权限，使用二进制安装（推荐）
        install_node_binary "$NODE_VERSION"
    fi
    
    #------------------------------------------------------------------------------
    # 配置 npm
    #------------------------------------------------------------------------------
    configure_npm
    
    #------------------------------------------------------------------------------
    # 验证安装
    #------------------------------------------------------------------------------
    if ! verify_installation; then
        log_error "安装验证失败"
        exit 1
    fi
    
    # 输出完成信息
    log_success "=========================================="
    log_success "Node.js 安装完成"
    log_success "=========================================="
}

# 调用主函数
main "$@"
