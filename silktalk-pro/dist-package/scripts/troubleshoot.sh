#!/bin/bash
#==============================================================================
# 脚本名称: troubleshoot.sh
# 功能描述: SilkTalk Pro 故障诊断脚本 - 自动识别问题并提供修复建议
# 作者: SilkTalk Team
# 版本: 1.0.0
# 日期: 2026-02-22
#==============================================================================
#
# 设计目标:
#   - 全面诊断: 覆盖 Node.js、依赖、端口、权限、网络、服务
#   - 自动修复: 支持自动修复常见问题
#   - 友好提示: 提供清晰的修复建议
#   - 安全操作: 修复前确认，避免误操作
#
# 诊断项目:
#   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
#   │   Node.js   │    │    依赖     │    │    端口     │
#   │ (安装/版本) │    │ (node_modules│    │  (占用检查) │
#   └─────────────┘    └─────────────┘    └─────────────┘
#   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
#   │    权限     │    │    网络     │    │    服务     │
#   │ (文件/用户) │    │ (连通/DNS)  │    │ (systemd)  │
#   └─────────────┘    └─────────────┘    └─────────────┘
#
# 使用方法:
#   ./troubleshoot.sh [选项]
#
# 选项:
#   --auto-fix         自动修复发现的问题
#   --verbose          详细输出
#
# 返回值:
#   0 - 无严重问题
#   >0 - 发现问题数量
#
# 示例:
#   # 诊断模式（仅检测）
#   ./troubleshoot.sh
#
#   # 自动修复模式
#   ./troubleshoot.sh --auto-fix
#
#==============================================================================

#------------------------------------------------------------------------------
# 严格模式设置
#------------------------------------------------------------------------------
set -euo pipefail

#------------------------------------------------------------------------------
# 全局配置
#------------------------------------------------------------------------------
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# 命令行参数
AUTO_FIX=false
VERBOSE=false

#------------------------------------------------------------------------------
# 颜色定义
#------------------------------------------------------------------------------
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

#------------------------------------------------------------------------------
# 日志函数
#------------------------------------------------------------------------------
log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }
log_success() { echo -e "${GREEN}[PASS]${NC} $*"; }
log_debug() { [[ "$VERBOSE" == true ]] && echo -e "${CYAN}[DEBUG]${NC} $*"; }

#------------------------------------------------------------------------------
# 参数解析
#------------------------------------------------------------------------------
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --auto-fix) AUTO_FIX=true; shift ;;
            --verbose) VERBOSE=true; shift ;;
            *) shift ;;
        esac
    done
}

#------------------------------------------------------------------------------
# 权限获取
#------------------------------------------------------------------------------

#==============================================================================
# 函数: get_sudo
# 描述: 获取 sudo 命令前缀
# 参数: 无
# 返回值: "" (root) 或 "sudo" (需提权)
#==============================================================================
get_sudo() {
    if [[ $EUID -eq 0 ]]; then
        echo ""
    elif command -v sudo &> /dev/null; then
        echo "sudo"
    else
        echo ""
    fi
}

#------------------------------------------------------------------------------
# Node.js 诊断
#------------------------------------------------------------------------------

#==============================================================================
# 函数: diagnose_nodejs
# 描述: 诊断 Node.js 安装和版本
# 参数: 无
# 返回值:
#   0 - Node.js 正常
#   1 - Node.js 有问题
# 自动修复:
#   - 未安装: 运行 setup-node.sh
#   - 版本过低: 升级 Node.js
#==============================================================================
diagnose_nodejs() {
    log_info "诊断 Node.js..."
    
    #------------------------------------------------------------------------------
    # 检查 Node.js 是否安装
    #------------------------------------------------------------------------------
    if ! command -v node &> /dev/null; then
        log_error "Node.js 未安装"
        echo "  修复: ./scripts/setup-node.sh"
        
        # 自动修复
        if [[ "$AUTO_FIX" == true ]]; then
            log_info "自动修复: 安装 Node.js..."
            bash "${SCRIPT_DIR}/setup-node.sh"
        fi
        return 1
    fi
    
    #------------------------------------------------------------------------------
    # 检查 Node.js 版本
    #------------------------------------------------------------------------------
    local version
    version=$(node --version | sed 's/v//')
    local major
    major=$(echo "$version" | cut -d. -f1)
    
    if [[ "$major" -lt 18 ]]; then
        log_warn "Node.js 版本过低: $version (需要 >= 18)"
        echo "  修复: ./scripts/setup-node.sh --force"
        
        # 自动修复
        if [[ "$AUTO_FIX" == true ]]; then
            log_info "自动修复: 升级 Node.js..."
            bash "${SCRIPT_DIR}/setup-node.sh" --force
        fi
        return 1
    fi
    
    log_success "Node.js 正常: v${version}"
    return 0
}

#------------------------------------------------------------------------------
# 依赖诊断
#------------------------------------------------------------------------------

#==============================================================================
# 函数: diagnose_dependencies
# 描述: 诊断项目依赖
# 参数: 无
# 返回值:
#   0 - 依赖正常
#   >0 - 问题数量
# 自动修复:
#   - 重新安装 node_modules
#==============================================================================
diagnose_dependencies() {
    log_info "诊断依赖..."
    
    local install_dir="${INSTALL_PREFIX:-/usr/local}/silktalk-pro"
    local issues=0
    
    #------------------------------------------------------------------------------
    # 检查安装目录
    #------------------------------------------------------------------------------
    if [[ ! -d "$install_dir" ]]; then
        log_error "安装目录不存在"
        return 1
    fi
    
    cd "$install_dir"
    
    #------------------------------------------------------------------------------
    # 检查 node_modules
    #------------------------------------------------------------------------------
    if [[ ! -d "node_modules" ]]; then
        log_error "node_modules 不存在"
        echo "  修复: cd $install_dir && npm install"
        
        # 自动修复
        if [[ "$AUTO_FIX" == true ]]; then
            log_info "自动修复: 安装依赖..."
            npm install --production
        fi
        ((issues++))
    fi
    
    #------------------------------------------------------------------------------
    # 检查关键依赖
    #------------------------------------------------------------------------------
    local key_deps=("express" "ws")
    for dep in "${key_deps[@]}"; do
        if [[ ! -d "node_modules/${dep}" ]]; then
            log_warn "依赖缺失: $dep"
            ((issues++))
        fi
    done
    
    if [[ $issues -eq 0 ]]; then
        log_success "依赖正常"
    fi
    
    return $issues
}

#------------------------------------------------------------------------------
# 端口诊断
#------------------------------------------------------------------------------

#==============================================================================
# 函数: diagnose_ports
# 描述: 诊断端口占用情况
# 参数: 无
# 返回值:
#   0 - 端口正常
#   >0 - 占用端口数量
#==============================================================================
diagnose_ports() {
    log_info "诊断端口..."
    
    local ports=(3000 3001 3478)
    local issues=0
    
    for port in "${ports[@]}"; do
        if netstat -tuln 2>/dev/null | grep -q ":${port} "; then
            local pid
            pid=$(lsof -t -i:${port} 2>/dev/null || echo "")
            if [[ -n "$pid" ]]; then
                log_warn "端口 ${port} 被占用 (PID: $pid)"
                echo "  查看: lsof -i:${port}"
                echo "  终止: kill -15 $pid"
                ((issues++))
            fi
        else
            log_debug "端口 ${port} 可用"
        fi
    done
    
    if [[ $issues -eq 0 ]]; then
        log_success "端口正常"
    fi
    
    return $issues
}

#------------------------------------------------------------------------------
# 权限诊断
#------------------------------------------------------------------------------

#==============================================================================
# 函数: diagnose_permissions
# 描述: 诊断文件权限
# 参数: 无
# 返回值:
#   0 - 权限正常
#   >0 - 问题数量
# 自动修复:
#   - 修复目录权限
#==============================================================================
diagnose_permissions() {
    log_info "诊断权限..."
    
    local install_dir="${INSTALL_PREFIX:-/usr/local}/silktalk-pro"
    local issues=0
    
    if [[ -d "$install_dir" ]]; then
        # 检查读取权限
        if [[ ! -r "$install_dir" ]]; then
            log_error "无法读取安装目录"
            ((issues++))
        fi
        
        # 检查日志目录写入权限
        if [[ ! -w "$install_dir/logs" ]]; then
            log_warn "无法写入日志目录"
            echo "  修复: chmod 755 ${install_dir}/logs"
            
            # 自动修复
            if [[ "$AUTO_FIX" == true ]]; then
                local sudo_cmd
                sudo_cmd=$(get_sudo)
                $sudo_cmd chmod 755 "${install_dir}/logs"
            fi
            ((issues++))
        fi
    fi
    
    if [[ $issues -eq 0 ]]; then
        log_success "权限正常"
    fi
    
    return $issues
}

#------------------------------------------------------------------------------
# 网络诊断
#------------------------------------------------------------------------------

#==============================================================================
# 函数: diagnose_network
# 描述: 诊断网络连接
# 参数: 无
# 返回值:
#   0 - 网络正常
#   >0 - 问题数量
#==============================================================================
diagnose_network() {
    log_info "诊断网络..."
    
    local issues=0
    
    #------------------------------------------------------------------------------
    # 检查外网连接
    #------------------------------------------------------------------------------
    if ! ping -c 1 -W 3 8.8.8.8 > /dev/null 2>&1; then
        log_warn "外网连接可能受限"
        ((issues++))
    fi
    
    #------------------------------------------------------------------------------
    # 检查 DNS
    #------------------------------------------------------------------------------
    if ! nslookup github.com > /dev/null 2>&1; then
        log_warn "DNS 解析可能有问题"
        ((issues++))
    fi
    
    if [[ $issues -eq 0 ]]; then
        log_success "网络正常"
    fi
    
    return $issues
}

#------------------------------------------------------------------------------
# 服务诊断
#------------------------------------------------------------------------------

#==============================================================================
# 函数: diagnose_service
# 描述: 诊断服务状态
# 参数: 无
# 返回值:
#   0 - 服务正常
#   >0 - 问题数量
#==============================================================================
diagnose_service() {
    log_info "诊断服务..."
    
    local issues=0
    
    #------------------------------------------------------------------------------
    # 检查 systemd 服务
    #------------------------------------------------------------------------------
    if [[ -f "/etc/systemd/system/silktalk.service" ]]; then
        if systemctl is-active --quiet silktalk 2>/dev/null; then
            log_success "服务正在运行"
        else
            log_warn "服务未运行"
            echo "  启动: sudo systemctl start silktalk"
            echo "  查看: sudo systemctl status silktalk"
            ((issues++))
        fi
    else
        log_info "未配置 systemd 服务"
    fi
    
    return $issues
}

#------------------------------------------------------------------------------
# 日志诊断
#------------------------------------------------------------------------------

#==============================================================================
# 函数: diagnose_logs
# 描述: 诊断日志文件
# 参数: 无
# 返回值: 无
# 说明:
#   - 检查日志文件是否存在
#   - 分析最近的错误
#==============================================================================
diagnose_logs() {
    log_info "诊断日志..."
    
    local install_dir="${INSTALL_PREFIX:-/usr/local}/silktalk-pro"
    local log_file="${install_dir}/logs/app.log"
    
    if [[ -f "$log_file" ]]; then
        log_info "日志文件存在"
        
        # 检查最近的错误
        local recent_errors
        recent_errors=$(tail -100 "$log_file" 2>/dev/null | grep -i "error\|fatal" | tail -5 || true)
        if [[ -n "$recent_errors" ]]; then
            log_warn "发现近期错误:"
            echo "$recent_errors" | while read -r line; do
                echo "  $line"
            done
        fi
    else
        log_info "日志文件不存在 (服务可能未启动)"
    fi
}

#------------------------------------------------------------------------------
# 修复建议
#------------------------------------------------------------------------------

#==============================================================================
# 函数: show_fix_suggestions
# 描述: 显示常见修复命令
# 参数: 无
# 返回值: 无
#==============================================================================
show_fix_suggestions() {
    echo ""
    echo "=========================================="
    echo "常见修复命令"
    echo "=========================================="
    echo ""
    echo "1. 重新安装依赖:"
    echo "   cd ${INSTALL_PREFIX:-/usr/local}/silktalk-pro && rm -rf node_modules && npm install"
    echo ""
    echo "2. 修复权限:"
    echo "   sudo chown -R $(whoami) ${INSTALL_PREFIX:-/usr/local}/silktalk-pro"
    echo ""
    echo "3. 重启服务:"
    echo "   sudo systemctl restart silktalk"
    echo ""
    echo "4. 查看日志:"
    echo "   tail -f ${INSTALL_PREFIX:-/usr/local}/silktalk-pro/logs/app.log"
    echo ""
    echo "5. 完整重新部署:"
    echo "   ./scripts/auto-deploy.sh --force"
    echo "=========================================="
}

#------------------------------------------------------------------------------
# 主函数
#------------------------------------------------------------------------------

#==============================================================================
# 函数: main
# 描述: 脚本入口函数
# 参数: $@ - 所有命令行参数
# 返回值:
#   0 - 无严重问题
#   >0 - 发现问题数量
#==============================================================================
main() {
    # 解析命令行参数
    parse_args "$@"
    
    # 输出开始信息
    log_info "=========================================="
    log_info "SilkTalk Pro 故障诊断"
    log_info "=========================================="
    
    if [[ "$AUTO_FIX" == true ]]; then
        log_info "自动修复模式已启用"
    fi
    
    local total_issues=0
    
    #------------------------------------------------------------------------------
    # 执行各项诊断
    #------------------------------------------------------------------------------
    diagnose_nodejs || ((total_issues++))
    diagnose_dependencies || ((total_issues+=$?))
    diagnose_ports || ((total_issues+=$?))
    diagnose_permissions || ((total_issues+=$?))
    diagnose_network || ((total_issues+=$?))
    diagnose_service || ((total_issues+=$?))
    diagnose_logs
    
    #------------------------------------------------------------------------------
    # 输出诊断结果
    #------------------------------------------------------------------------------
    echo ""
    if [[ $total_issues -eq 0 ]]; then
        log_success "=========================================="
        log_success "诊断完成: 未发现严重问题"
        log_success "=========================================="
    else
        log_warn "=========================================="
        log_warn "诊断完成: 发现 $total_issues 个问题"
        log_warn "=========================================="
        show_fix_suggestions
    fi
}

# 调用主函数
main "$@"
