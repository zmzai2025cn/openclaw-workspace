# 需求规格说明书 (SRS)
## Software Requirements Specification

**文档编号**: STP-SRS-001  
**版本**: 1.0.0  
**日期**: 2026-02-22  
**状态**: 已批准  
**作者**: SilkTalk Pro 开发团队  
**审核人**: 待签字  

---

## 1. 引言

### 1.1 目的
本文档详细描述了 SilkTalk Pro 企业级 P2P 通信系统的软件需求规格，旨在为开发、测试、部署和维护提供全面的需求基准。

### 1.2 范围
SilkTalk Pro 是一个基于 libp2p 的企业级点对点通信系统，支持多传输协议、NAT 穿透、DHT 路由和消息传递。

### 1.3 定义和缩略语

| 缩略语 | 全称 | 说明 |
|--------|------|------|
| P2P | Peer-to-Peer | 点对点 |
| DHT | Distributed Hash Table | 分布式哈希表 |
| NAT | Network Address Translation | 网络地址转换 |
| UPnP | Universal Plug and Play | 通用即插即用 |
| mDNS | Multicast DNS | 多播 DNS |
| WebSocket | WebSocket Protocol | Web 套接字协议 |
| libp2p | Library Peer-to-Peer | 模块化 P2P 网络栈 |
| ACK | Acknowledgment | 确认消息 |

### 1.4 参考资料
- ISO/IEC 12207:2017 系统和软件工程 - 软件生命周期过程
- CMMI-DEV V2.0 能力成熟度模型集成
- libp2p 规范文档
- WebSocket RFC 6455

### 1.5 文档结构
本文档按照 IEEE 830-1998 标准组织，包含业务需求、功能需求、非功能需求、边界条件和需求追溯矩阵。

---

## 2. 业务需求分析

### 2.1 业务背景
在现代分布式系统中，传统的客户端-服务器架构面临以下挑战：
- 单点故障风险
- 中心化服务器的带宽和存储成本
- 隐私和数据主权问题
- 网络审查和封锁

P2P 通信提供了一种去中心化的解决方案，允许节点直接通信，无需依赖中心化基础设施。

### 2.2 业务目标

#### 2.2.1 主要目标
1. **去中心化通信**: 实现无需中心化服务器的点对点消息传递
2. **网络适应性**: 在各种网络环境下（包括 NAT 和防火墙后）保持连通性
3. **企业级可靠性**: 提供高可用性、安全性和可扩展性
4. **易用性**: 提供简洁的 API 和 CLI 接口

#### 2.2.2 业务价值
- 降低通信基础设施成本
- 提高系统容错能力
- 增强数据隐私保护
- 支持离线优先的协作场景

### 2.3 利益相关者

| 角色 | 需求 | 优先级 |
|------|------|--------|
| 终端用户 | 稳定的消息传递、低延迟 | 高 |
| 系统管理员 | 易于部署和监控 | 高 |
| 开发者 | 清晰的 API 和文档 | 中 |
| 安全团队 | 端到端加密、身份验证 | 高 |

### 2.4 业务规则
1. 每个节点必须有唯一的身份标识（PeerId）
2. 消息传递必须支持至少一次送达语义
3. 系统必须能够自动适应网络拓扑变化
4. 所有连接必须使用加密传输

---

## 3. 功能需求

### 3.1 节点管理

#### FR-NM-001 节点生命周期管理
**描述**: 系统必须支持节点的启动、运行和停止生命周期管理。

**详细需求**:
- 节点启动时必须加载或生成身份密钥
- 节点启动时必须初始化网络传输层
- 节点停止时必须优雅地关闭所有连接
- 节点必须能够报告当前运行状态

**验收标准**:
- 节点启动时间 < 5 秒
- 节点停止时间 < 3 秒
- 状态查询响应时间 < 100ms

#### FR-NM-002 身份管理
**描述**: 系统必须提供安全的身份管理机制。

**详细需求**:
- 支持生成新的加密身份
- 支持加载现有的身份密钥
- 身份密钥必须安全存储
- 支持身份导出和备份

**验收标准**:
- 身份生成使用 Ed25519 算法
- 私钥存储使用 600 权限
- 导出格式支持 hex 编码

### 3.2 网络连接

#### FR-NC-001 传输协议支持
**描述**: 系统必须支持多种传输协议。

**详细需求**:
- 必须支持 TCP 传输
- 必须支持 WebSocket 传输
- 可选支持 WebRTC 传输
- 传输协议必须可配置启用/禁用

**验收标准**:
- TCP 传输必须支持 IPv4 和 IPv6
- WebSocket 必须支持 ws:// 和 wss://
- 传输协议切换时间 < 1 秒

#### FR-NC-002 NAT 穿透
**描述**: 系统必须能够在 NAT 环境下建立连接。

**详细需求**:
- 必须支持 UPnP 端口映射
- 必须支持 AutoNAT 检测
- 必须支持 DCUtR 协议
- 必须能够检测 NAT 类型

**验收标准**:
- 在 Full Cone NAT 下直接连接成功率 > 95%
- 在 Restricted NAT 下使用 STUN 成功率 > 90%
- 在 Symmetric NAT 下使用 Relay 成功率 > 95%

#### FR-NC-003 中继连接
**描述**: 系统必须在直接连接失败时使用中继。

**详细需求**:
- 必须支持 Circuit Relay V2 协议
- 必须能够作为中继客户端
- 可选支持作为中继服务器
- 中继连接必须自动降级

**验收标准**:
- 中继连接建立时间 < 10 秒
- 中继连接带宽 > 100KB/s
- 支持最多 100 个中继预留

### 3.3 对等点发现

#### FR-PD-001 本地发现
**描述**: 系统必须支持本地网络中的对等点发现。

**详细需求**:
- 必须支持 mDNS 发现
- 发现必须在本地子网内工作
- 发现结果必须包含地址和协议信息

**验收标准**:
- mDNS 发现时间 < 5 秒
- 发现范围限制在本地子网

#### FR-PD-002 DHT 发现
**描述**: 系统必须支持通过 DHT 进行全局发现。

**详细需求**:
- 必须实现 Kademlia DHT 协议
- 必须支持内容路由
- 必须支持对等点路由
- DHT 必须是可选功能

**验收标准**:
- DHT 查找时间 < 30 秒
- 路由表大小 > 20 个节点
- 支持 24 小时的内容提供

#### FR-PD-003 引导节点
**描述**: 系统必须支持通过引导节点加入网络。

**详细需求**:
- 必须支持配置多个引导节点
- 引导节点地址必须支持 DNS 解析
- 引导连接失败必须自动重试

**验收标准**:
- 支持至少 5 个引导节点
- 引导连接重试间隔 30 秒
- 最大重试次数 10 次

### 3.4 消息传递

#### FR-MP-001 消息协议
**描述**: 系统必须实现自定义消息协议。

**详细需求**:
- 协议标识: `/silktalk/1.0.0/messages`
- 必须支持消息版本控制
- 必须支持消息类型区分
- 必须支持消息 ACK 机制

**验收标准**:
- 协议版本兼容性检查
- 消息序列化使用 JSON
- 支持消息压缩

#### FR-MP-002 消息类型
**描述**: 系统必须支持多种消息类型。

**详细需求**:
- HELLO: 握手消息
- TEXT: 文本消息
- DATA: 二进制数据消息
- COMMAND: 命令消息
- ACK: 确认消息
- ERROR: 错误消息

**验收标准**:
- 每种类型有明确的 payload 结构
- 类型字段使用枚举值
- 支持扩展类型

#### FR-MP-003 消息可靠性
**描述**: 系统必须提供可靠的消息传递。

**详细需求**:
- 必须支持消息确认
- 必须支持消息重传
- 必须支持消息超时处理
- 必须支持消息顺序保证

**验收标准**:
- 消息送达确认时间 < 5 秒
- 最大重传次数 3 次
- 消息超时 30 秒

### 3.5 DHT 操作

#### FR-DHT-001 数据存储
**描述**: 系统必须支持在 DHT 中存储数据。

**详细需求**:
- 必须支持键值对存储
- 必须支持 TTL 设置
- 必须支持数据验证

**验收标准**:
- 存储操作时间 < 5 秒
- 最大键长度 256 字节
- 最大值大小 10KB

#### FR-DHT-002 数据检索
**描述**: 系统必须支持从 DHT 检索数据。

**详细需求**:
- 必须支持按键检索
- 必须支持超时设置
- 必须处理数据不存在情况

**验收标准**:
- 检索操作时间 < 10 秒
- 支持本地缓存
- 缓存 TTL 可配置

### 3.6 CLI 接口

#### FR-CLI-001 节点控制
**描述**: 系统必须提供 CLI 控制接口。

**详细需求**:
- 必须支持启动节点
- 必须支持停止节点
- 必须支持查看状态
- 必须支持配置管理

**验收标准**:
- 命令响应时间 < 1 秒
- 支持 JSON 输出格式
- 支持配置文件

#### FR-CLI-002 消息操作
**描述**: CLI 必须支持消息操作。

**详细需求**:
- 必须支持发送消息
- 必须支持监听消息
- 必须支持查看连接的对等点

**验收标准**:
- 发送消息延迟 < 2 秒
- 支持消息过滤
- 支持格式化输出

### 3.7 OpenClaw 桥接

#### FR-BR-001 命令桥接
**描述**: 系统必须支持与 OpenClaw 代理系统集成。

**详细需求**:
- 必须支持远程命令执行
- 必须支持命令结果返回
- 必须支持授权机制

**验收标准**:
- 命令执行时间 < 5 秒
- 支持命令白名单
- 支持权限验证

---

## 4. 非功能需求

### 4.1 性能需求

#### NFR-PF-001 响应时间
| 操作 | 目标 | 最大值 |
|------|------|--------|
| 节点启动 | < 3s | 5s |
| 连接建立 | < 2s | 5s |
| 消息发送 | < 500ms | 2s |
| DHT 查找 | < 10s | 30s |

#### NFR-PF-002 吞吐量
- 单节点并发连接数: 300+
- 消息吞吐量: 1000+ 消息/秒
- DHT 存储容量: 10000+ 记录

#### NFR-PF-003 资源使用
- 内存使用: < 512MB (典型负载)
- CPU 使用: < 50% (单核)
- 磁盘使用: < 100MB (不含日志)

### 4.2 安全需求

#### NFR-SC-001 传输安全
- 所有连接必须使用 Noise 协议加密
- 支持 Perfect Forward Secrecy
- 证书固定支持

#### NFR-SC-002 身份安全
- 私钥必须安全存储
- 支持硬件安全模块 (HSM)
- 身份轮换机制

#### NFR-SC-003 访问控制
- 命令执行需要授权
- 支持 IP 白名单
- 支持速率限制

### 4.3 可靠性需求

#### NFR-RL-001 可用性
- 系统可用性: 99.9%
- 计划外停机: < 8.76 小时/年
- 支持热更新

#### NFR-RL-002 容错
- 网络分区自动恢复
- 对等点故障自动切换
- 数据持久化

#### NFR-RL-003 数据一致性
- 消息至少一次送达
- DHT 数据最终一致性
- 支持冲突解决

### 4.4 可维护性需求

#### NFR-MT-001 可观测性
- 结构化日志输出
- 支持 Prometheus 指标
- 支持分布式追踪

#### NFR-MT-002 可配置性
- 配置文件热加载
- 环境变量支持
- 命令行参数覆盖

#### NFR-MT-003 可测试性
- 单元测试覆盖率 > 90%
- 集成测试覆盖主要场景
- E2E 测试覆盖关键路径

### 4.5 可移植性需求

#### NFR-PT-001 平台支持
- Node.js 18+ (Linux, macOS, Windows)
- Docker 容器化部署
- Kubernetes 支持

#### NFR-PT-002 兼容性
- 向后兼容协议版本
- 支持滚动升级
- 降级策略

### 4.6 可用性需求

#### NFR-US-001 易用性
- 一键启动脚本
- 清晰的错误消息
- 详细的文档

#### NFR-US-002 可访问性
- CLI 支持自动化
- API 文档完整
- 示例代码丰富

---

## 5. 边界条件与异常场景

### 5.1 网络边界条件

#### BC-NW-001 网络分区
**场景**: 网络被划分为多个隔离区域
**行为**: 
- 每个分区继续本地操作
- 分区恢复后自动同步
- 记录分区事件

#### BC-NW-002 高延迟网络
**场景**: 网络延迟 > 500ms
**行为**:
- 增加超时阈值
- 使用异步操作
- 显示延迟警告

#### BC-NW-003 高丢包率
**场景**: 丢包率 > 10%
**行为**:
- 增加重传次数
- 使用更小的数据包
- 降级到低带宽模式

### 5.2 资源边界条件

#### BC-RS-001 内存不足
**场景**: 可用内存 < 100MB
**行为**:
- 清理缓存
- 关闭空闲连接
- 记录警告日志

#### BC-RS-002 连接数上限
**场景**: 达到最大连接数限制
**行为**:
- 拒绝新连接
- 优先保留活跃连接
- 通知管理员

#### BC-RS-003 磁盘空间不足
**场景**: 可用磁盘空间 < 1GB
**行为**:
- 停止写入日志
- 清理旧日志
- 发送告警

### 5.3 异常场景

#### EX-SC-001 身份密钥丢失
**场景**: 身份密钥文件损坏或丢失
**行为**:
- 生成新身份
- 记录安全事件
- 通知管理员

#### EX-SC-002 协议版本不匹配
**场景**: 与对等点协议版本不兼容
**行为**:
- 拒绝连接
- 记录不兼容事件
- 尝试协商版本

#### EX-SC-003 消息验证失败
**场景**: 收到无效或篡改的消息
**行为**:
- 丢弃消息
- 记录安全事件
- 可选断开连接

---

## 6. 需求追溯矩阵

### 6.1 需求到设计的追溯

| 需求 ID | 需求描述 | 设计文档 | 模块 | 优先级 |
|---------|----------|----------|------|--------|
| FR-NM-001 | 节点生命周期 | LLD-Core | node.ts | 高 |
| FR-NM-002 | 身份管理 | LLD-Core | identity.ts | 高 |
| FR-NC-001 | 传输协议 | LLD-Network | transport-manager.ts | 高 |
| FR-NC-002 | NAT 穿透 | LLD-Network | nat-traversal.ts | 高 |
| FR-NC-003 | 中继连接 | LLD-Network | connection-manager.ts | 高 |
| FR-PD-001 | 本地发现 | LLD-Routing | discovery.ts | 中 |
| FR-PD-002 | DHT 发现 | LLD-Routing | dht.ts | 高 |
| FR-PD-003 | 引导节点 | LLD-Routing | discovery.ts | 中 |
| FR-MP-001 | 消息协议 | LLD-Protocol | handler.ts | 高 |
| FR-MP-002 | 消息类型 | LLD-Core | types.ts | 高 |
| FR-MP-003 | 消息可靠性 | LLD-Protocol | handler.ts | 高 |
| FR-DHT-001 | 数据存储 | LLD-Routing | dht.ts | 中 |
| FR-DHT-002 | 数据检索 | LLD-Routing | dht.ts | 中 |
| FR-CLI-001 | 节点控制 | LLD-CLI | index.ts | 高 |
| FR-CLI-002 | 消息操作 | LLD-CLI | index.ts | 高 |
| FR-BR-001 | 命令桥接 | LLD-Bridge | openclaw.ts | 低 |

### 6.2 需求到代码的追溯

| 需求 ID | 代码文件 | 函数/类 | 行号范围 |
|---------|----------|---------|----------|
| FR-NM-001 | src/core/node.ts | SilkNode.start() | 80-130 |
| FR-NM-001 | src/core/node.ts | SilkNode.stop() | 132-155 |
| FR-NM-002 | src/core/identity.ts | IdentityManager | 15-120 |
| FR-NC-001 | src/core/node.ts | buildLibp2pConfig() | 350-420 |
| FR-NC-002 | src/network/nat-traversal.ts | NatTraversal | 30-180 |
| FR-NC-003 | src/core/node.ts | buildLibp2pConfig() | 380-390 |
| FR-PD-001 | src/routing/discovery.ts | PeerDiscovery | 25-200 |
| FR-PD-002 | src/routing/dht.ts | DHTRouting | 20-250 |
| FR-MP-001 | src/protocol/handler.ts | MessageHandler | 20-180 |
| FR-MP-002 | src/core/types.ts | MessageType | 15-25 |
| FR-CLI-001 | src/cli/index.ts | start command | 30-120 |
| FR-BR-001 | src/bridge/openclaw.ts | OpenClawBridge | 25-200 |

### 6.3 需求到测试的追溯

| 需求 ID | 测试类型 | 测试文件 | 测试用例 |
|---------|----------|----------|----------|
| FR-NM-001 | 单元测试 | tests/unit/core/node.test.ts | TC-NODE-001 ~ TC-NODE-005 |
| FR-NM-002 | 单元测试 | tests/unit/core/identity.test.ts | TC-ID-001 ~ TC-ID-004 |
| FR-NC-001 | 集成测试 | tests/integration/transport.test.ts | TC-TR-001 ~ TC-TR-003 |
| FR-NC-002 | E2E 测试 | tests/e2e/nat-traversal.test.ts | TC-NAT-001 ~ TC-NAT-005 |
| FR-PD-002 | 集成测试 | tests/integration/dht.test.ts | TC-DHT-001 ~ TC-DHT-004 |
| FR-MP-001 | 单元测试 | tests/unit/protocol/handler.test.ts | TC-MSG-001 ~ TC-MSG-010 |
| FR-MP-003 | E2E 测试 | tests/e2e/messaging.test.ts | TC-MSG-E2E-001 ~ TC-MSG-E2E-005 |
| FR-CLI-001 | E2E 测试 | tests/e2e/cli.test.ts | TC-CLI-001 ~ TC-CLI-003 |

---

## 7. 附录

### 7.1 变更历史

| 版本 | 日期 | 作者 | 变更描述 |
|------|------|------|----------|
| 1.0.0 | 2026-02-22 | SilkTalk Team | 初始版本 |

### 7.2 审核记录

| 审核轮次 | 审核日期 | 审核人 | 结果 | 备注 |
|----------|----------|--------|------|------|
| 1 | | | | |

### 7.3 批准签字

**需求分析师**: _________________ 日期: _______

**系统架构师**: _________________ 日期: _______

**项目经理**: _________________ 日期: _______

**质量保证**: _________________ 日期: _______

---

**文档结束**
