#!/bin/bash
#==============================================================================
# 脚本名称: install-deps.sh
# 功能描述: SilkTalk Pro 系统依赖安装脚本 - 自动检测并安装系统依赖
# 作者: SilkTalk Team
# 版本: 1.0.0
# 日期: 2026-02-22
#==============================================================================
#
# 设计目标:
#   - 自动适配: 自动检测并使用系统包管理器
#   - 全面覆盖: 支持所有主流 Linux 发行版
#   - 镜像加速: 支持配置国内镜像源
#   - 无 root 支持: 受限环境下提供替代方案
#
# 支持的平台:
#   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
#   │   Ubuntu    │    │   CentOS    │    │   Alpine    │
#   │   Debian    │    │    RHEL     │    │   Arch      │
#   └─────────────┘    └─────────────┘    └─────────────┘
#
# 安装内容:
#   - 基础工具: curl, wget, git, tar, unzip, ca-certificates
#   - 构建工具: make, gcc, g++, python3, pkg-config
#   - Node.js 编译依赖: libssl-dev, zlib-dev 等
#
# 使用方法:
#   ./install-deps.sh [选项]
#
# 选项:
#   --mode <mode>      安装模式: auto|semi (默认: auto)
#   --mirror <source>  镜像源: auto|cn|global (默认: auto)
#   --verbose           详细输出
#
# 返回值:
#   0 - 安装成功
#   1 - 安装失败
#
# 示例:
#   # 标准安装
#   ./install-deps.sh
#
#   # 使用国内镜像
#   ./install-deps.sh --mirror cn
#
#   # 详细输出
#   ./install-deps.sh --verbose
#
#==============================================================================

#------------------------------------------------------------------------------
# 严格模式设置
#------------------------------------------------------------------------------
set -euo pipefail

#------------------------------------------------------------------------------
# 全局配置
#------------------------------------------------------------------------------
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# 命令行参数
MODE="auto"
USE_MIRROR="auto"
VERBOSE=false

#------------------------------------------------------------------------------
# 颜色定义
#------------------------------------------------------------------------------
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

#------------------------------------------------------------------------------
# 日志函数
#------------------------------------------------------------------------------

#==============================================================================
# 函数: log_info
# 描述: 输出信息级别日志（蓝色）
#==============================================================================
log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }

#==============================================================================
# 函数: log_warn
# 描述: 输出警告级别日志（黄色）
#==============================================================================
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }

#==============================================================================
# 函数: log_error
# 描述: 输出错误级别日志（红色）
#==============================================================================
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

#==============================================================================
# 函数: log_success
# 描述: 输出成功级别日志（绿色）
#==============================================================================
log_success() { echo -e "${GREEN}[PASS]${NC} $*"; }

#------------------------------------------------------------------------------
# 参数解析
#------------------------------------------------------------------------------

#==============================================================================
# 函数: parse_args
# 描述: 解析命令行参数
#==============================================================================
parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --mode) MODE="$2"; shift 2 ;;
            --mirror) USE_MIRROR="$2"; shift 2 ;;
            --verbose) VERBOSE=true; shift ;;
            *) shift ;;
        esac
    done
}

#------------------------------------------------------------------------------
# 包管理器检测
#------------------------------------------------------------------------------

#==============================================================================
# 函数: detect_package_manager
# 描述: 检测系统使用的包管理器
# 参数: 无
# 返回值: 包管理器名称 (apt|yum|dnf|pacman|apk|zypper|unknown)
# 检测逻辑:
#   1. 检查 apt-get (Debian/Ubuntu)
#   2. 检查 dnf (Fedora/RHEL 8+)
#   3. 检查 yum (CentOS/RHEL 7)
#   4. 检查 pacman (Arch)
#   5. 检查 apk (Alpine)
#   6. 检查 zypper (openSUSE)
#==============================================================================
detect_package_manager() {
    if command -v apt-get &> /dev/null; then
        echo "apt"
    elif command -v yum &> /dev/null; then
        echo "yum"
    elif command -v dnf &> /dev/null; then
        echo "dnf"
    elif command -v pacman &> /dev/null; then
        echo "pacman"
    elif command -v apk &> /dev/null; then
        echo "apk"
    elif command -v zypper &> /dev/null; then
        echo "zypper"
    else
        echo "unknown"
    fi
}

#------------------------------------------------------------------------------
# 权限获取
#------------------------------------------------------------------------------

#==============================================================================
# 函数: get_sudo
# 描述: 获取 sudo 命令前缀
# 参数: 无
# 返回值: 
#   "" (空) - 当前是 root 用户
#   "sudo"  - 需要 sudo 提权
# 说明: 在受限环境中可能返回空字符串
#==============================================================================
get_sudo() {
    if [[ $EUID -eq 0 ]]; then
        # 当前是 root，不需要 sudo
        echo ""
    elif command -v sudo &> /dev/null; then
        # 有 sudo 命令，返回 sudo 前缀
        echo "sudo"
    else
        # 无 sudo，返回空（受限环境）
        echo ""
    fi
}

#------------------------------------------------------------------------------
# 包管理器特定安装函数
#------------------------------------------------------------------------------

#==============================================================================
# 函数: install_apt
# 描述: 使用 apt-get 安装依赖（Debian/Ubuntu）
# 参数: 无
# 返回值: 0=成功, 1=失败
# 安装内容:
#   - 基础工具: curl, wget, git, tar, unzip, ca-certificates, gnupg
#   - 构建工具: build-essential, python3, python3-pip, pkg-config
#   - Node.js 编译依赖: libssl-dev, zlib1g-dev 等
#==============================================================================
install_apt() {
    local sudo_cmd
    sudo_cmd=$(get_sudo)
    
    #------------------------------------------------------------------------------
    # 更新包列表
    #------------------------------------------------------------------------------
    # -qq: 静默模式，仅显示错误
    log_info "更新包列表..."
    $sudo_cmd apt-get update -qq
    
    #------------------------------------------------------------------------------
    # 安装基础依赖
    #------------------------------------------------------------------------------
    log_info "安装基础依赖..."
    $sudo_cmd apt-get install -y -qq \
        curl \
        wget \
        git \
        tar \
        unzip \
        ca-certificates \
        gnupg \
        lsb-release
    
    #------------------------------------------------------------------------------
    # 安装构建依赖
    #------------------------------------------------------------------------------
    # 使用 2>/dev/null 忽略可能的错误（某些包可能不存在）
    log_info "安装构建依赖..."
    $sudo_cmd apt-get install -y -qq \
        build-essential \
        python3 \
        python3-pip \
        pkg-config \
        2>/dev/null || log_warn "部分构建依赖安装失败"
    
    #------------------------------------------------------------------------------
    # 安装 Node.js 编译依赖
    #------------------------------------------------------------------------------
    # 这些库用于编译原生 Node.js 模块
    log_info "安装 Node.js 编译依赖..."
    $sudo_cmd apt-get install -y -qq \
        libssl-dev \
        zlib1g-dev \
        libbz2-dev \
        libreadline-dev \
        libsqlite3-dev \
        llvm \
        libncurses5-dev \
        xz-utils \
        tk-dev \
        libxml2-dev \
        libxmlsec1-dev \
        libffi-dev \
        liblzma-dev \
        2>/dev/null || log_warn "部分库安装失败"
}

#==============================================================================
# 函数: install_yum
# 描述: 使用 yum/dnf 安装依赖（CentOS/RHEL/Fedora）
# 参数:
#   $1 - 包管理器名称 (yum 或 dnf)
# 返回值: 0=成功, 1=失败
# 安装内容:
#   - 基础工具: curl, wget, git, tar, unzip, ca-certificates
#   - 开发工具组: Development Tools
#   - Node.js 编译依赖: openssl-devel, zlib-devel 等
#==============================================================================
install_yum() {
    local sudo_cmd
    sudo_cmd=$(get_sudo)
    local pkg_manager="${1:-yum}"
    
    #------------------------------------------------------------------------------
    # 安装基础依赖
    #------------------------------------------------------------------------------
    log_info "安装基础依赖..."
    $sudo_cmd $pkg_manager install -y -q \
        curl \
        wget \
        git \
        tar \
        unzip \
        ca-certificates
    
    #------------------------------------------------------------------------------
    # 安装开发工具
    #------------------------------------------------------------------------------
    # 尝试安装 Development Tools 组，失败则单独安装 gcc
    log_info "安装构建依赖..."
    $sudo_cmd $pkg_manager groupinstall -y "Development Tools" 2>/dev/null || \
        $sudo_cmd $pkg_manager install -y -q gcc gcc-c++ make
    
    #------------------------------------------------------------------------------
    # 安装 Node.js 编译依赖
    #------------------------------------------------------------------------------
    $sudo_cmd $pkg_manager install -y -q \
        python3 \
        python3-pip \
        openssl-devel \
        zlib-devel \
        bzip2-devel \
        readline-devel \
        sqlite-devel \
        ncurses-devel \
        xz-devel \
        libffi-devel
}

#==============================================================================
# 函数: install_pacman
# 描述: 使用 pacman 安装依赖（Arch Linux）
# 参数: 无
# 返回值: 0=成功, 1=失败
#==============================================================================
install_pacman() {
    local sudo_cmd
    sudo_cmd=$(get_sudo)
    
    #------------------------------------------------------------------------------
    # 更新包数据库
    #------------------------------------------------------------------------------
    # -Sy: 同步包数据库
    log_info "更新包数据库..."
    $sudo_cmd pacman -Sy --noconfirm --quiet
    
    #------------------------------------------------------------------------------
    # 安装依赖
    #------------------------------------------------------------------------------
    # -S: 安装
    # --noconfirm: 自动确认
    # --quiet: 静默模式
    log_info "安装依赖..."
    $sudo_cmd pacman -S --noconfirm --quiet \
        curl \
        wget \
        git \
        tar \
        unzip \
        base-devel \
        python3 \
        openssl \
        zlib
}

#==============================================================================
# 函数: install_apk
# 描述: 使用 apk 安装依赖（Alpine Linux）
# 参数: 无
# 返回值: 0=成功, 1=失败
# 注意: Alpine 使用 musl libc，与 glibc 不同
#==============================================================================
install_apk() {
    local sudo_cmd
    sudo_cmd=$(get_sudo)
    
    #------------------------------------------------------------------------------
    # 更新包索引
    #------------------------------------------------------------------------------
    log_info "更新包索引..."
    $sudo_cmd apk update --quiet
    
    #------------------------------------------------------------------------------
    # 安装依赖
    #------------------------------------------------------------------------------
    # build-base: 相当于 build-essential
    # linux-headers: 内核头文件，某些 npm 包需要
    log_info "安装依赖..."
    $sudo_cmd apk add --quiet \
        curl \
        wget \
        git \
        tar \
        unzip \
        build-base \
        python3 \
        py3-pip \
        openssl-dev \
        zlib-dev \
        bzip2-dev \
        readline-dev \
        sqlite-dev \
        ncurses-dev \
        linux-headers
}

#------------------------------------------------------------------------------
# 用户级安装（无 root 权限）
#------------------------------------------------------------------------------

#==============================================================================
# 函数: install_user_deps
# 描述: 在无 root 权限时执行用户级安装
# 参数: 无
# 返回值: 0=成功
# 说明:
#   - 创建用户级目录结构
#   - 检查并配置 PATH
#   - 列出无法自动安装的工具
#==============================================================================
install_user_deps() {
    log_warn "无 root 权限，使用用户级安装"
    
    #------------------------------------------------------------------------------
    # 创建用户级目录
    #------------------------------------------------------------------------------
    mkdir -p "$HOME/.local/bin"
    mkdir -p "$HOME/.local/lib"
    mkdir -p "$HOME/.local/share"
    
    #------------------------------------------------------------------------------
    # 配置 PATH
    #------------------------------------------------------------------------------
    # 检查 PATH 是否已包含 ~/.local/bin
    if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
        log_info "添加 ~/.local/bin 到 PATH"
        # 添加到 .bashrc 以便持久化
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> "$HOME/.bashrc"
        # 当前会话生效
        export PATH="$HOME/.local/bin:$PATH"
    fi
    
    #------------------------------------------------------------------------------
    # 检查缺失的工具
    #------------------------------------------------------------------------------
    local missing_tools=()
    for tool in curl wget git tar unzip; do
        if ! command -v "$tool" &> /dev/null; then
            missing_tools+=("$tool")
        fi
    done
    
    # 列出无法自动安装的工具
    if [[ ${#missing_tools[@]} -gt 0 ]]; then
        log_warn "以下工具缺失但无法自动安装: ${missing_tools[*]}"
        log_warn "请联系系统管理员安装"
    fi
}

#------------------------------------------------------------------------------
# 镜像源配置
#------------------------------------------------------------------------------

#==============================================================================
# 函数: setup_mirrors
# 描述: 配置国内镜像源以加速下载
# 参数: 无
# 返回值: 0=成功
# 说明:
#   - 仅当 USE_MIRROR=cn 时执行
#   - 备份原配置
#   - 根据发行版配置相应镜像
#==============================================================================
setup_mirrors() {
    # 仅在中国镜像模式下配置
    [[ "$USE_MIRROR" != "cn" ]] && return 0
    
    log_info "配置中国镜像源..."
    
    local pkg_manager
    pkg_manager=$(detect_package_manager)
    local sudo_cmd
    sudo_cmd=$(get_sudo)
    
    case "$pkg_manager" in
        apt)
            #------------------------------------------------------------------------------
            # 配置 apt 国内镜像
            #------------------------------------------------------------------------------
            # 备份原配置
            if [[ -f /etc/apt/sources.list ]]; then
                $sudo_cmd cp /etc/apt/sources.list "/etc/apt/sources.list.bak.$(date +%Y%m%d)"
            fi
            
            # 检测发行版并配置对应镜像
            if [[ -f /etc/os-release ]]; then
                # shellcheck source=/dev/null
                source /etc/os-release
                case "$ID" in
                    ubuntu)
                        # 阿里云 Ubuntu 镜像
                        $sudo_cmd sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
                        $sudo_cmd sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list
                        ;;
                    debian)
                        # 阿里云 Debian 镜像
                        $sudo_cmd sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list
                        $sudo_cmd sed -i 's/security.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list
                        ;;
                esac
                # 更新包列表
                $sudo_cmd apt-get update -qq
            fi
            ;;
        # 其他包管理器的镜像配置可在此扩展
    esac
}

#------------------------------------------------------------------------------
# 主函数
#------------------------------------------------------------------------------

#==============================================================================
# 函数: main
# 描述: 脚本入口函数
# 参数: $@ - 所有命令行参数
# 返回值:
#   0 - 安装成功
#   1 - 安装失败
#==============================================================================
main() {
    # 解析命令行参数
    parse_args "$@"
    
    # 输出开始信息
    log_info "=========================================="
    log_info "SilkTalk Pro 依赖安装"
    log_info "=========================================="
    
    #------------------------------------------------------------------------------
    # 检测包管理器
    #------------------------------------------------------------------------------
    local pkg_manager
    pkg_manager=$(detect_package_manager)
    log_info "包管理器: $pkg_manager"
    
    #------------------------------------------------------------------------------
    # 配置镜像源
    #------------------------------------------------------------------------------
    if [[ "$USE_MIRROR" == "cn" ]]; then
        setup_mirrors
    fi
    
    #------------------------------------------------------------------------------
    # 根据包管理器执行安装
    #------------------------------------------------------------------------------
    case "$pkg_manager" in
        apt)
            install_apt
            ;;
        yum)
            install_yum "yum"
            ;;
        dnf)
            install_yum "dnf"
            ;;
        pacman)
            install_pacman
            ;;
        apk)
            install_apk
            ;;
        unknown)
            # 未知包管理器，检查是否为受限环境
            if [[ $EUID -ne 0 ]] && ! command -v sudo &> /dev/null; then
                install_user_deps
            else
                log_error "未知的包管理器，无法自动安装依赖"
                exit 1
            fi
            ;;
    esac
    
    # 输出完成信息
    log_success "=========================================="
    log_success "依赖安装完成"
    log_success "=========================================="
}

# 调用主函数
main "$@"
