# 架构设计

## 1. 设计目标

### 1.1 核心需求
- **可靠性**: 消息不丢失，崩溃可恢复
- **性能**: 支持高并发写入，低延迟查询
- **可运维**: 部署简单，监控完善，故障可定位
- **可扩展**: 支持数据增长，易于水平扩展

### 1.2 非功能性需求
| 指标 | 目标 | 说明 |
|------|------|------|
| 数据可靠性 | 99.999% | WAL保障，崩溃不丢数据 |
| 写入延迟 | <10ms | 内存缓冲，异步刷盘 |
| 查询延迟 | <100ms | 索引优化，百万级数据 |
| 可用性 | 99.9% | 自动恢复，健康检查 |
| 运维成本 | 低 | 单节点，Docker部署 |

## 2. 架构概览

### 2.1 分层架构

```
┌─────────────────────────────────────────┐
│  接入层 (Adapter Layer)                 │
│  - OpenClaw集成                         │
│  - HTTP健康检查                         │
├─────────────────────────────────────────┤
│  业务层 (Service Layer)                 │
│  - OptimizedChatArchive 主类            │
│  - 消息路由、查询、管理                 │
├─────────────────────────────────────────┤
│  智能解析层 (Intelligence Layer)        │
│  - InvertedIndex (倒排索引)             │
│  - MultiLabelParser (多标签解析)        │
│  - SessionManager (会话上下文)          │
│  - FeedbackManager (反馈学习)           │
├─────────────────────────────────────────┤
│  核心层 (Core Layer)                    │
│  - BufferedWriter (缓冲写入)            │
│  - WAL (预写日志)                       │
│  - ArchiveDB (持久化)                   │
├─────────────────────────────────────────┤
│  支撑层 (Support Layer)                 │
│  - BackupManager (备份)                 │
│  - CleanupManager (清理)                │
│  - HealthMonitor (监控)                 │
│  - Logger (日志)                        │
│  - EventBus (事件总线)                  │
│  - DataMasker (隐私保护)                │
└─────────────────────────────────────────┘
```

### 2.2 数据流

```
消息到达
    ↓
[OpenClaw Adapter]
    ↓
[OptimizedChatArchive.archive()]
    ↓
[InvertedIndex.query()] ──→ 快速类型检测（O(1)）
    ↓
[MultiLabelParser.parse()] ──→ 多标签解析
    ↓
[DataMasker.mask()] ──→ 隐私脱敏（可选）
    ↓
[SessionManager.process()] ──→ 关联会话
    ↓
[EventBus.emit()] ──→ 实时通知
    ↓
[WAL.append()] ───────→ WAL文件（持久化）
    ↓
[Buffer.add()] ───────→ 内存缓冲区
    ↓ (满100条或5分钟)
[DB.insertBatch()] ───→ DuckDB（持久化）
    ↓
[WAL.clear()] ────────→ 清空WAL
    ↓
[FeedbackManager] ────→ 收集反馈优化模型
```

## 3. 核心组件

### 3.1 WAL (Write-Ahead Log)

**职责**: 确保数据不丢失

**机制**:
1. 消息到达立即追加到WAL文件（同步写）
2. 成功写入DB后，清空WAL
3. 崩溃重启时，从WAL恢复未提交数据

**文件格式**: `wal.jsonl`（每行一个JSON对象）

### 3.2 BufferedWriter

**职责**: 批量写入，提高性能

**策略**:
- 缓冲区大小: 100条
- 刷新间隔: 5分钟
- 任一条件满足即触发刷新

**容错**:
- 写入失败时，数据保留在缓冲区
- WAL仍在，数据不丢
- 下次刷新重试

### 3.3 ArchiveDB (DuckDB)

**职责**: 数据持久化与查询

**表结构**:
```sql
CREATE TABLE messages (
  id VARCHAR PRIMARY KEY,
  timestamp TIMESTAMP,
  channel VARCHAR,
  chat_id VARCHAR,
  chat_name VARCHAR,
  user_id VARCHAR,
  user_name VARCHAR,
  content TEXT,
  is_mentioned BOOLEAN,
  reply_to VARCHAR,
  metadata JSON
);
```

**索引**:
- timestamp（时间范围查询）
- chat_id（群聊查询）
- user_id（用户查询）
- channel（渠道查询）

### 3.4 BackupManager

**职责**: 自动备份

**策略**:
- 每日全量备份
- 保留7份历史
- 自动清理旧备份

**备份文件**: `backup_YYYY-MM-DDTHH-mm-ss.db`

### 3.5 CleanupManager

**职责**: 数据生命周期管理

**策略**:
- 保留90天数据
- 超期数据可归档到对象存储
- 自动删除过期数据

### 3.6 HealthMonitor

**职责**: 系统健康监控

**端点**:
- `/health` - 健康状态（200/503）
- `/metrics` - 监控指标（JSON）
- `/ready` - 就绪检查（200）

**监控项**:
- 数据库状态
- WAL状态
- 缓冲区状态
- 磁盘空间
- 内存使用

### 3.7 EventBus 事件总线

**职责**: 实时事件通知和订阅

**特性**:
- 发布-订阅模式
- 中间件支持
- 异步处理

**事件类型**:
- `message.received` - 新消息到达
- `message.parsed` - 消息解析完成
- `session.created` - 新会话创建
- `ticket.created` - 新工单创建
- `alert.critical` - 严重告警

### 3.8 SessionManager 会话管理

**职责**: 关联同一事件的多条消息

**机制**:
- 基于时间窗口（默认30分钟）
- 基于工单号关联
- 基于参与者关联
- 基于标签相似度

### 3.9 DataMasker 数据脱敏

**职责**: 敏感数据自动脱敏

**支持类型**:
- 手机号: 138****1234
- 身份证号: 110**********1234
- 邮箱: zh***@example.com
- 银行卡: 6222 **** **** 1234
- IP地址: 192.168.*.*

### 3.10 FeedbackManager 反馈学习

**职责**: 基于人工反馈优化解析模型

**流程**:
1. 收集用户反馈（正确/修正）
2. 统计准确率
3. 分析错误模式
4. 自动生成优化建议

---

## 4. 技术选型

### 4.1 数据库: DuckDB

**选择理由**:
- 单文件，零运维
- 分析型查询快
- 压缩率高
- SQL兼容

**对比**:
| 数据库 | 运维复杂度 | 查询性能 | 适用场景 |
|--------|-----------|---------|---------|
| DuckDB | 极低 | 高 | 单机，分析型 |
| PostgreSQL | 中 | 中 | 事务型，多用户 |
| ClickHouse | 高 | 极高 | 分布式，大数据 |

### 4.2 运行时: Node.js

**选择理由**:
- TypeScript原生支持
- 异步IO，高并发
- 生态丰富

### 4.3 部署: Docker

**选择理由**:
- 环境一致性
- 一键部署
- 易于扩展

## 5. 容错设计

### 5.1 单点故障

| 组件 | 故障场景 | 应对策略 |
|------|---------|---------|
| 应用崩溃 | 进程退出 | WAL恢复，重启后继续 |
| 磁盘满 | 无法写入 | 健康检查失败，告警 |
| DB损坏 | 文件损坏 | 从备份恢复 |
| 内存不足 | OOM | 缓冲区限制，优雅降级 |

### 5.2 数据一致性

- WAL先于DB写入，确保不丢
- 批量写入原子性
- 定期备份，可回滚

## 6. 扩展性设计

### 6.1 垂直扩展

- 单节点可支撑：
  - 日写入：100万条
  - 存储：100GB
  - 查询：QPS 1000

### 6.2 水平扩展（未来）

- 按时间分片
- 读写分离
- 对象存储归档冷数据

## 7. 安全设计

见 [SECURITY.md](SECURITY.md)

## 8. 性能优化

### 8.1 写入优化
- 内存缓冲
- 批量插入
- WAL顺序写

### 8.2 查询优化
- 索引覆盖
- 分区（未来）
- 缓存热点数据（未来）

## 9. 监控告警

### 9.1 关键指标

| 指标 | 阈值 | 告警级别 |
|------|------|---------|
| 磁盘使用率 | >90% | 紧急 |
| 内存使用率 | >85% | 警告 |
| 写入失败率 | >1% | 紧急 |
| 查询延迟 | >1s | 警告 |

### 9.2 日志规范

- 结构化JSON
- 分级：DEBUG/INFO/WARN/ERROR
- 关键操作全链路追踪

## 10. 部署架构

```
┌─────────────────┐
│   Load Balancer │ (可选)
└────────┬────────┘
         │
┌────────▼────────┐
│  Chat Archive   │ Docker容器
│  - 主应用        │
│  - 健康检查:8080 │
└────────┬────────┘
         │
┌────────▼────────┐
│   Data Volume   │
│  - chat.db      │
│  - wal.jsonl    │
│  - backups/     │
│  - logs/        │
└─────────────────┘
```
