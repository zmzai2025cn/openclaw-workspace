# WiseClaw Core Architecture v2.1
## ç°å®è·¯çº¿å®Œæ•´è®¾è®¡

**ç‰ˆæœ¬**: 2.1 (Reality Edition)  
**è®¾è®¡åŸåˆ™**: æ‰¿è®¤å±€é™ Ã— å¯è¾¾ç›®æ ‡ Ã— æ¸è¿›æ¼”è¿›  
**æ ¸å¿ƒéšå–»**: Reliable Assistant, not Perfect AI

---

## ç›®å½•

1. [è®¾è®¡å“²å­¦](#ä¸€è®¾è®¡å“²å­¦)
2. [æ¶æ„æ€»è§ˆ](#äºŒæ¶æ„æ€»è§ˆ)
3. [æ ¸å¿ƒç³»ç»Ÿ](#ä¸‰æ ¸å¿ƒç³»ç»Ÿ)
4. [éªŒæ”¶æ ‡å‡†](#å››éªŒæ”¶æ ‡å‡†)
5. [å®æ–½è®¡åˆ’](#äº”å®æ–½è®¡åˆ’)
6. [é£é™©ç¼“è§£](#å…­é£é™©ç¼“è§£)
7. [æ¼”è¿›è·¯çº¿](#ä¸ƒæ¼”è¿›è·¯çº¿)

---

## ä¸€ã€è®¾è®¡å“²å­¦

### 1.1 æˆ‘ä»¬æ‰¿è®¤çš„çº¦æŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç°å®çº¦æŸ                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. LLMæ— æ³•å¯é è‡ªè¯„ä¼°ï¼Œç½®ä¿¡åº¦ç³»ç»Ÿåªèƒ½ä½œä¸ºå‚è€ƒ                     â”‚
â”‚  2. ä¸­æ–‡è¯­è¨€å¤æ‚ï¼Œå…³é”®è¯è·¯ç”±å‡†ç¡®ç‡ä¸Šé™çº¦80%                       â”‚
â”‚  3. ç”¨æˆ·ä¸æ„¿é¢‘ç¹å‚ä¸è®°å¿†ç®¡ç†ï¼Œé‡‡ç”¨ç‡å¯èƒ½<50%                      â”‚
â”‚  4. Checkpointä¼šæ‰“æ–­ç”¨æˆ·ä½“éªŒï¼Œéƒ¨åˆ†ç”¨æˆ·ä¼šå…³é—­                      â”‚
â”‚  5. å¼€å‘æ—¶é—´8å‘¨ï¼Œä¸æ˜¯4å‘¨                                         â”‚
â”‚  6. ä»£ç é‡çº¦4000è¡Œï¼Œä¸æ˜¯3000è¡Œ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 è°ƒæ•´åçš„ç›®æ ‡

| ç»´åº¦ | åŸå§‹ç›®æ ‡ | ç°å®ç›®æ ‡ | ç†ç”± |
|-----|---------|---------|------|
| è·¯ç”±å‡†ç¡®ç‡ | 90% | **80%** | ç®€å•è§„åˆ™ä¸Šé™ |
| è®°å¿†å¬å›ç‡ | 80% | **60%** | å…³é”®è¯åŒ¹é…å±€é™ |
| é•¿é“¾è·¯æˆåŠŸç‡ | 80% | **65%** | 3æ­¥ä»¥å†…å¯è¾¾ |
| ä»£ç è¡Œæ•° | <3000 | **<4000** | å®Œæ•´åŠŸèƒ½éœ€è¦ |
| å¼€å‘æ—¶é—´ | 4å‘¨ | **8å‘¨** | åŒ…å«æµ‹è¯•ä¼˜åŒ– |
| ç”¨æˆ·æ»¡æ„åº¦ | 4.5/5 | **4.0/5** | ç°å®æœŸæœ› |

### 1.3 æ ¸å¿ƒè®¾è®¡å†³ç­–

| å†³ç­– | é€‰æ‹© | ç†ç”± |
|-----|------|------|
| è·¯ç”±å¤±è´¥å¤„ç† | æä¾›æ˜¾å¼è¦†ç›–æŒ‡ä»¤ | ç”¨æˆ·å¯çº æ­£è¯¯åˆ¤ |
| è®°å¿†ç®¡ç† | è‡ªåŠ¨æç¤º + ä¸€é”®ç¡®è®¤ | é™ä½ç”¨æˆ·è´Ÿæ‹… |
| Checkpoint | å¯é…ç½®ï¼Œå¯å…³é—­ | å°Šé‡ç”¨æˆ·åå¥½ |
| ç½®ä¿¡åº¦ | ä»…æ ‡æ³¨low/medium | highä¸æ ‡æ³¨ï¼Œé¿å…å™ªéŸ³ |
| é”™è¯¯æ¢å¤ | ç®€å•é‡è¯• + äººå·¥æ¥ç®¡ | ä¸è¿½æ±‚è‡ªåŠ¨æ¢å¤ |

---

## äºŒã€æ¶æ„æ€»è§ˆ

### 2.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·äº¤äº’å±‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Feishu  â”‚ â”‚Telegram â”‚ â”‚ Discord â”‚ â”‚   CLI   â”‚ â”‚ WebChat â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚           â”‚           â”‚           â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           OpenClaw Gateway (Unchanged)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         WiseClaw Core Kernel                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      è·¯ç”±å±‚ (Router)                                  â”‚    â”‚
â”‚  â”‚   è¾“å…¥åˆ†ç±» â†’ æ·±åº¦å†³ç­– â†’ (å¯é€‰)ç”¨æˆ·è¦†ç›–                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      æ‰§è¡Œå±‚ (Executor)                                â”‚     â”‚
â”‚  â”‚   ä¸Šä¸‹æ–‡ç»„è£… â†’ LLMè°ƒç”¨ â†’ ç½®ä¿¡åº¦æ ‡æ³¨ â†’ è¾“å‡ºå¤„ç†                          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      è®°å¿†å±‚ (Memory)                                  â”‚     â”‚
â”‚  â”‚   å·¥ä½œè®°å¿†ç®¡ç† â†’ è®°å¿†æ£€ç´¢ â†’ (å¯é€‰)è®°å¿†æç¤º â†’ ç”¨æˆ·ç¡®è®¤                     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                    â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                      é“¾è·¯å±‚ (Chain) [å¯é€‰]                             â”‚     â”‚
â”‚  â”‚   Checkpointç®¡ç† â†’ ç”¨æˆ·ç¡®è®¤ â†’ å›æ»š/ç»§ç»­                               â”‚     â”‚
â”‚  â”‚   (å¯é…ç½®å…³é—­)                                                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         çŠ¶æ€å­˜å‚¨ (3 Files)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚   WORKING.md     â”‚  â”‚   MEMORY.md      â”‚  â”‚   CONFIG.md      â”‚         â”‚
â”‚   â”‚   (å·¥ä½œè®°å¿†)      â”‚  â”‚   (é•¿æœŸè®°å¿†)      â”‚  â”‚   (ç”¨æˆ·é…ç½®)      â”‚         â”‚
â”‚   â”‚   è‡ªåŠ¨ç®¡ç†        â”‚  â”‚   ç”¨æˆ·ç¡®è®¤åå†™å…¥   â”‚  â”‚   æ‰‹åŠ¨ç¼–è¾‘        â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¾“å…¥åˆ†ç±» (Input Classification)       â”‚
â”‚    - å…³é”®è¯åŒ¹é…                          â”‚
â”‚    - ç¡®å®šåˆæ­¥æ·±åº¦: light/standard/deep   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. (å¯é€‰) ç”¨æˆ·è¦†ç›–                       â”‚
â”‚    - å¦‚æœç”¨æˆ·è¯´"è¯¦ç»†è¯´" â†’ å¼ºåˆ¶deep      â”‚
â”‚    - å¦‚æœç”¨æˆ·è¯´"ç®€å•ç‚¹" â†’ å¼ºåˆ¶light     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ·±åº¦å†³ç­– (Depth Decision)             â”‚
â”‚    light:   <150 tokens, æ— å·¥å…·          â”‚
â”‚    standard: <800 tokens, å¯ç”¨å·¥å…·       â”‚
â”‚    deep:    <2000 tokens, å·¥å…·+checkpointâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ä¸Šä¸‹æ–‡ç»„è£… (Context Assembly)         â”‚
â”‚    - è¯»å–WORKING.md                      â”‚
â”‚    - æ£€ç´¢MEMORY.md (top-3)               â”‚
â”‚    - è¯»å–CONFIG.mdåå¥½                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. LLMè°ƒç”¨ (Generation)                  â”‚
â”‚    - ç”Ÿæˆå›å¤                            â”‚
â”‚    - æ£€æµ‹ç½®ä¿¡åº¦ä¿¡å·                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ç½®ä¿¡åº¦æ ‡æ³¨ (Confidence Labeling)      â”‚
â”‚    high:    æ— æ ‡æ³¨                       â”‚
â”‚    medium:  "ï¼ˆåŸºäºç°æœ‰ä¿¡æ¯ï¼‰"            â”‚
â”‚    low:     "ï¼ˆä¸ç¡®å®šï¼Œå»ºè®®éªŒè¯ï¼‰"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. (å¯é€‰) Checkpoint [å¦‚æœdepth=deep]    â”‚
â”‚    - æ£€æµ‹[CHECKPOINT]æ ‡è®°                â”‚
â”‚    - æš‚åœç­‰å¾…ç”¨æˆ·ç¡®è®¤                    â”‚
â”‚    - æ”¯æŒ: ç»§ç»­/ä¿®æ”¹/å›æ»š                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. (å¯é€‰) è®°å¿†æç¤º                       â”‚
â”‚    - æ£€æµ‹å€¼å¾—è®°å¿†çš„å†…å®¹                  â”‚
â”‚    - ä¸€é”®ç¡®è®¤å†™å…¥MEMORY.md               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. æ›´æ–°çŠ¶æ€                              â”‚
â”‚    - æ›´æ–°WORKING.md                      â”‚
â”‚    - è®°å½•äº¤äº’å†å²                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
  è¾“å‡ºç»™ç”¨æˆ·
```

---

## ä¸‰ã€æ ¸å¿ƒç³»ç»Ÿ

### 3.1 è·¯ç”±å±‚ (Router)

#### 3.1.1 è¾“å…¥åˆ†ç±»å™¨

```typescript
interface ClassificationResult {
  primaryDepth: 'light' | 'standard' | 'deep';
  confidence: 'high' | 'medium' | 'low';
  matchedPattern: string | null;
  reason: string;
}

function classifyInput(input: string, config: Config): ClassificationResult {
  const text = input.toLowerCase().trim();
  
  // 1. æ˜¾å¼æ·±åº¦æŒ‡ä»¤ (æœ€é«˜ä¼˜å…ˆçº§)
  if (matchesAny(text, config.patterns.forceDeep)) {
    return {
      primaryDepth: 'deep',
      confidence: 'high',
      matchedPattern: 'forceDeep',
      reason: 'ç”¨æˆ·æ˜¾å¼è¦æ±‚è¯¦ç»†å›å¤'
    };
  }
  
  if (matchesAny(text, config.patterns.forceLight)) {
    return {
      primaryDepth: 'light',
      confidence: 'high',
      matchedPattern: 'forceLight',
      reason: 'ç”¨æˆ·æ˜¾å¼è¦æ±‚ç®€æ´å›å¤'
    };
  }
  
  // 2. ç¤¾äº¤ç¤¼èŠ‚
  if (matchesAny(text, config.patterns.social)) {
    return {
      primaryDepth: 'light',
      confidence: 'high',
      matchedPattern: 'social',
      reason: 'ç¤¾äº¤ç¤¼èŠ‚ï¼Œæ— éœ€æ·±åº¦å¤„ç†'
    };
  }
  
  // 3. æ·±åº¦å…³é”®è¯
  if (matchesAny(text, config.patterns.deepKeywords)) {
    return {
      primaryDepth: 'deep',
      confidence: 'medium',
      matchedPattern: 'deepKeyword',
      reason: `åŒ¹é…æ·±åº¦å…³é”®è¯: ${findMatchingKeyword(text, config.patterns.deepKeywords)}`
    };
  }
  
  // 4. è½»é‡å…³é”®è¯
  if (matchesAny(text, config.patterns.lightKeywords)) {
    return {
      primaryDepth: 'light',
      confidence: 'medium',
      matchedPattern: 'lightKeyword',
      reason: 'åŒ¹é…è½»é‡å…³é”®è¯'
    };
  }
  
  // 5. é»˜è®¤
  return {
    primaryDepth: 'standard',
    confidence: 'medium',
    matchedPattern: null,
    reason: 'æ— ç‰¹å®šåŒ¹é…ï¼Œä½¿ç”¨é»˜è®¤æ·±åº¦'
  };
}
```

#### 3.1.2 é»˜è®¤é…ç½®

```yaml
# CONFIG.md - è·¯ç”±é…ç½®
routing:
  # æ˜¾å¼æ·±åº¦æŒ‡ä»¤ (æœ€é«˜ä¼˜å…ˆçº§)
  forceDeep:
    - "è¯¦ç»†"
    - "æ·±å…¥"
    - "å®Œæ•´"
    - "å…¨é¢"
    - "å½»åº•"
    - "è¯¦ç»†è¯´"
    - "æ·±å…¥è®²"
    - "å±•å¼€è¯´"
    
  forceLight:
    - "ç®€å•"
    - "ç®€è¦"
    - "å¿«é€Ÿ"
    - "ä¸€å¥è¯"
    - "ç®€å•è¯´"
    - "tl;dr"
    - "å¤ªé•¿ä¸çœ‹"
    
  # ç¤¾äº¤ç¤¼èŠ‚ (è‡ªåŠ¨light)
  social:
    - "å¥½çš„"
    - "ok"
    - "okay"
    - "ğŸ‘"
    - "ğŸ‘Œ"
    - "æ”¶åˆ°"
    - "æ˜ç™½"
    - "äº†è§£"
    - "è°¢è°¢"
    - "æ„Ÿè°¢"
    - "è¾›è‹¦äº†"
    
  # æ·±åº¦å…³é”®è¯ (å»ºè®®deep)
  deepKeywords:
    - "è®¾è®¡"
    - "æ¶æ„"
    - "é‡æ„"
    - "ä¼˜åŒ–"
    - "åˆ†æ"
    - "è§„åˆ’"
    - "ç­–ç•¥"
    - "æ–¹æ¡ˆ"
    - "å®ç°"
    - "å¼€å‘"
    - "æ’æŸ¥"
    - "debug"
    - "æ•…éšœ"
    - "é—®é¢˜"
    - "åŸå› "
    
  # è½»é‡å…³é”®è¯ (å»ºè®®light)
  lightKeywords:
    - "ä½ å¥½"
    - "åœ¨å—"
    - "å¿™å—"
    - "è°¢è°¢"
    - "å†è§"
    - "æ‹œæ‹œ"
```

#### 3.1.3 æ·±åº¦å†³ç­–

```typescript
interface DepthConfig {
  level: 'light' | 'standard' | 'deep';
  maxTokens: number;
  useTools: boolean;
  enableCheckpoints: boolean;
  systemPromptModifier: string;
}

const depthConfigs: Record<string, DepthConfig> = {
  light: {
    level: 'light',
    maxTokens: 150,
    useTools: false,
    enableCheckpoints: false,
    systemPromptModifier: 'ç®€æ´å›å¤ï¼Œä¸è¶…è¿‡2å¥è¯ï¼Œç›´æ¥ç»™å‡ºç­”æ¡ˆï¼Œä¸è§£é‡Šã€‚'
  },
  
  standard: {
    level: 'standard',
    maxTokens: 800,
    useTools: true,
    enableCheckpoints: false,
    systemPromptModifier: 'æ­£å¸¸å›å¤ï¼Œç»“æ„æ¸…æ™°ï¼Œå¿…è¦æ—¶ä½¿ç”¨å·¥å…·ã€‚'
  },
  
  deep: {
    level: 'deep',
    maxTokens: 2000,
    useTools: true,
    enableCheckpoints: true,
    systemPromptModifier: 'è¯¦ç»†å›å¤ï¼Œç»“æ„åŒ–è¾“å‡ºï¼Œå…³é”®æ­¥éª¤æ ‡æ³¨[CHECKPOINT]ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤åç»§ç»­ã€‚'
  }
};

function getDepthConfig(classification: ClassificationResult): DepthConfig {
  return depthConfigs[classification.primaryDepth];
}
```

### 3.2 æ‰§è¡Œå±‚ (Executor)

#### 3.2.1 ä¸Šä¸‹æ–‡ç»„è£…

```typescript
interface AssembledContext {
  systemPrompt: string;
  workingState: WorkingState;
  relevantMemories: Memory[];
  userPreferences: UserPreferences;
  depthConfig: DepthConfig;
  sessionHistory: Message[];
}

function assembleContext(
  input: string,
  classification: ClassificationResult,
  config: Config
): AssembledContext {
  const depthConfig = getDepthConfig(classification);
  
  return {
    systemPrompt: buildSystemPrompt(config, depthConfig),
    workingState: loadWorkingState(),
    relevantMemories: retrieveRelevantMemories(input, 3),
    userPreferences: config.preferences,
    depthConfig,
    sessionHistory: getRecentHistory(10)
  };
}

function buildSystemPrompt(config: Config, depth: DepthConfig): string {
  return `
ä½ æ˜¯WiseClawï¼Œä¸€ä¸ªå¯é çš„AIåŠ©æ‰‹ã€‚

${depth.systemPromptModifier}

ç”¨æˆ·åå¥½:
- æ²Ÿé€šé£æ ¼: ${config.preferences.communicationStyle}
- æŠ€æœ¯æ·±åº¦: ${config.preferences.technicalDepth}

é‡è¦èƒŒæ™¯:
${loadRelevantMemories().map(m => `- ${m.content}`).join('\n')}

å½“å‰ä»»åŠ¡æ·±åº¦: ${depth.level}
${depth.enableCheckpoints ? 'æ³¨æ„: å…³é”®æ­¥éª¤åæ ‡æ³¨[CHECKPOINT]ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤ã€‚' : ''}

å¦‚æœä¸ç¡®å®šï¼Œè¯·æ˜ç¡®è¯´æ˜ã€‚
`;
}
```

#### 3.2.2 ç½®ä¿¡åº¦è¯„ä¼°ä¸æ ‡æ³¨

```typescript
type ConfidenceLevel = 'high' | 'medium' | 'low';

interface ConfidenceAssessment {
  level: ConfidenceLevel;
  reason: string;
  shouldAnnotate: boolean;
}

function assessConfidence(
  input: string,
  output: string,
  context: AssembledContext
): ConfidenceAssessment {
  // ç®€å•å¯å‘å¼è§„åˆ™
  const indicators = {
    low: [
      'æˆ‘ä¸çŸ¥é“',
      'ä¸ç¡®å®š',
      'å¯èƒ½',
      'ä¹Ÿè®¸',
      'çŒœæµ‹',
      'æ²¡æœ‰ç›¸å…³ä¿¡æ¯',
      'è¶…å‡ºæˆ‘çš„çŸ¥è¯†èŒƒå›´'
    ],
    medium: [
      'æ ¹æ®ç°æœ‰ä¿¡æ¯',
      'å¯èƒ½',
      'å»ºè®®',
      'ä¸€èˆ¬æ¥è¯´',
      'é€šå¸¸'
    ]
  };
  
  const outputLower = output.toLowerCase();
  
  // æ£€æµ‹lowä¿¡å·
  if (indicators.low.some(s => outputLower.includes(s))) {
    return {
      level: 'low',
      reason: 'æ£€æµ‹åˆ°ä¸ç¡®å®šæ€§è¡¨è¾¾',
      shouldAnnotate: true
    };
  }
  
  // æ£€æµ‹mediumä¿¡å·
  if (indicators.medium.some(s => outputLower.includes(s))) {
    return {
      level: 'medium',
      reason: 'æ£€æµ‹åˆ°æ¨æ–­æ€§è¡¨è¾¾',
      shouldAnnotate: true
    };
  }
  
  // é»˜è®¤highï¼Œä¸æ ‡æ³¨
  return {
    level: 'high',
    reason: 'æ— ä¸ç¡®å®šæ€§ä¿¡å·',
    shouldAnnotate: false
  };
}

function annotateOutput(output: string, confidence: ConfidenceAssessment): string {
  if (!confidence.shouldAnnotate) {
    return output;
  }
  
  const prefix = {
    medium: 'ï¼ˆåŸºäºç°æœ‰ä¿¡æ¯çš„æœ€ä½³åˆ¤æ–­ï¼‰\n\n',
    low: 'ï¼ˆå¯¹æ­¤ä¸å¤ªç¡®å®šï¼Œå»ºè®®éªŒè¯ï¼‰\n\n'
  };
  
  return prefix[confidence.level] + output;
}
```

### 3.3 è®°å¿†å±‚ (Memory)

#### 3.3.1 å·¥ä½œè®°å¿†ç®¡ç†

```typescript
interface WorkingState {
  sessionId: string;
  startedAt: Date;
  lastUpdate: Date;
  messageCount: number;
  tokenUsage: number;
  currentGoal: string | null;
  context: {
    currentTopic: string | null;
    recentFacts: string[];
  };
}

class WorkingMemoryManager {
  private state: WorkingState;
  
  constructor() {
    this.state = this.loadOrCreate();
  }
  
  update(input: string, output: string, usage: TokenUsage): void {
    this.state.lastUpdate = new Date();
    this.state.messageCount++;
    this.state.tokenUsage += usage.total;
    
    // æ›´æ–°å½“å‰è¯é¢˜
    this.state.context.currentTopic = extractTopic(input, output);
    
    // æå–æœ€è¿‘äº‹å® (æœ€å¤š5ä¸ª)
    const newFacts = extractFacts(input, output);
    this.state.context.recentFacts = [
      ...newFacts,
      ...this.state.context.recentFacts
    ].slice(0, 5);
    
    this.save();
  }
  
  getState(): WorkingState {
    return { ...this.state };
  }
  
  reset(): void {
    this.state = this.createEmptyState();
    this.save();
  }
  
  private loadOrCreate(): WorkingState {
    try {
      const content = readFileSync('WORKING.md', 'utf-8');
      return parseWorkingMd(content);
    } catch {
      return this.createEmptyState();
    }
  }
  
  private save(): void {
    writeFileSync('WORKING.md', formatWorkingMd(this.state));
  }
  
  private createEmptyState(): WorkingState {
    return {
      sessionId: generateSessionId(),
      startedAt: new Date(),
      lastUpdate: new Date(),
      messageCount: 0,
      tokenUsage: 0,
      currentGoal: null,
      context: {
        currentTopic: null,
        recentFacts: []
      }
    };
  }
}
```

#### 3.3.2 é•¿æœŸè®°å¿†æ£€ç´¢

```typescript
interface Memory {
  id: string;
  category: 'fact' | 'preference' | 'todo';
  content: string;
  createdAt: Date;
  source: string; // å“ªæ¬¡å¯¹è¯äº§ç”Ÿçš„
}

function retrieveRelevantMemories(
  query: string,
  maxResults: number = 3
): Memory[] {
  const memories = loadMemories();
  
  // ç®€å•å…³é”®è¯åŒ¹é… + è¯„åˆ†
  const scored = memories.map(memory => ({
    memory,
    score: calculateRelevanceScore(query, memory)
  }));
  
  // æ’åºå¹¶å–top-N
  return scored
    .sort((a, b) => b.score - a.score)
    .slice(0, maxResults)
    .map(s => s.memory);
}

function calculateRelevanceScore(query: string, memory: Memory): number {
  let score = 0;
  
  const queryWords = query.toLowerCase().split(/\s+/);
  const memoryText = memory.content.toLowerCase();
  
  // å…³é”®è¯åŒ¹é…
  for (const word of queryWords) {
    if (memoryText.includes(word)) {
      score += 10;
    }
  }
  
  // ç±»åˆ«ä¼˜å…ˆçº§
  const categoryBonus = {
    'preference': 5,
    'fact': 3,
    'todo': 1
  };
  score += categoryBonus[memory.category] || 0;
  
  // æ—¶é—´è¡°å‡ (30å¤©åŠè¡°æœŸ)
  const daysOld = (Date.now() - memory.createdAt.getTime()) / (1000 * 60 * 60 * 24);
  score *= Math.exp(-daysOld / 30);
  
  return score;
}
```

#### 3.3.3 è®°å¿†æç¤º (ä¸€é”®ç¡®è®¤)

```typescript
interface MemoryCandidate {
  content: string;
  category: 'fact' | 'preference' | 'todo';
  confidence: 'high' | 'medium' | 'low';
  reason: string;
}

function detectMemoryCandidates(
  input: string,
  output: string
): MemoryCandidate[] {
  const candidates: MemoryCandidate[] = [];
  
  // è§„åˆ™1: ç”¨æˆ·æ˜ç¡®é™ˆè¿°åå¥½
  const preferenceMatch = input.match(/æˆ‘(å–œæ¬¢|åå¥½|ä¹ æƒ¯|è®¨åŒ)(.+)/);
  if (preferenceMatch) {
    candidates.push({
      content: `ç”¨æˆ·${preferenceMatch[1]}: ${preferenceMatch[2]}`,
      category: 'preference',
      confidence: 'high',
      reason: 'ç”¨æˆ·æ˜ç¡®é™ˆè¿°åå¥½'
    });
  }
  
  // è§„åˆ™2: ç”¨æˆ·è¦æ±‚è®°ä½
  const rememberMatch = input.match(/è®°ä½[:ï¼š]\s*(.+)/);
  if (rememberMatch) {
    candidates.push({
      content: rememberMatch[1],
      category: 'fact',
      confidence: 'high',
      reason: 'ç”¨æˆ·æ˜ç¡®è¦æ±‚è®°å¿†'
    });
  }
  
  // è§„åˆ™3: é‡è¦äº‹å® (é¡¹ç›®åã€æŠ€æœ¯æ ˆç­‰)
  const factPatterns = [
    { pattern: /é¡¹ç›®å«["']?([^"']+)["']?/, desc: 'é¡¹ç›®åç§°' },
    { pattern: /ç”¨["']?([^"']+)["']?å¼€å‘/, desc: 'æŠ€æœ¯æ ˆ' },
    { pattern: /ç›®æ ‡æ˜¯["']?([^"']+)["']?/, desc: 'é¡¹ç›®ç›®æ ‡' }
  ];
  
  for (const { pattern, desc } of factPatterns) {
    const match = input.match(pattern) || output.match(pattern);
    if (match) {
      candidates.push({
        content: `${desc}: ${match[1]}`,
        category: 'fact',
        confidence: 'medium',
        reason: `æ£€æµ‹åˆ°${desc}`
      });
    }
  }
  
  return candidates;
}

// ç”¨æˆ·ç¡®è®¤ç•Œé¢
interface MemoryPrompt {
  type: 'MEMORY_SUGGESTION';
  message: 'æ£€æµ‹åˆ°å¯èƒ½å€¼å¾—è®°å½•çš„ä¿¡æ¯ï¼š';
  candidates: MemoryCandidate[];
  actions: {
    confirm: (selectedIds: string[]) => void;  // ç¡®è®¤é€‰ä¸­çš„
    dismiss: () => void;  // å…¨éƒ¨å¿½ç•¥
    remindLater: () => void;  // ç¨åæé†’
  };
}
```

### 3.4 é“¾è·¯å±‚ (Chain) [å¯é€‰]

#### 3.4.1 Checkpointæœºåˆ¶

```typescript
interface Checkpoint {
  id: string;
  stepNumber: number;
  description: string;
  output: string;
  timestamp: Date;
}

interface ChainState {
  chainId: string;
  totalSteps: number;
  currentStep: number;
  checkpoints: Checkpoint[];
  status: 'active' | 'waiting_confirmation' | 'completed' | 'aborted';
}

class ChainManager {
  private state: ChainState | null = null;
  private config: ChainConfig;
  
  constructor(config: ChainConfig) {
    this.config = config;
  }
  
  startChain(totalSteps: number): void {
    if (!this.config.enabled) return;
    
    this.state = {
      chainId: generateId(),
      totalSteps,
      currentStep: 0,
      checkpoints: [],
      status: 'active'
    };
    
    this.saveState();
  }
  
  createCheckpoint(output: string): Checkpoint | null {
    if (!this.config.enabled || !this.state) return null;
    
    // æŒ‰é…ç½®é—´éš”åˆ›å»ºcheckpoint
    if (this.state.currentStep % this.config.checkpointInterval !== 0) {
      this.state.currentStep++;
      return null;
    }
    
    const checkpoint: Checkpoint = {
      id: generateId(),
      stepNumber: this.state.currentStep,
      description: this.extractKeyDecision(output),
      output,
      timestamp: new Date()
    };
    
    this.state.checkpoints.push(checkpoint);
    this.state.status = 'waiting_confirmation';
    this.saveState();
    
    return checkpoint;
  }
  
  async waitForUserDecision(checkpoint: Checkpoint): Promise<UserDecision> {
    // å‘é€checkpointç»™ç”¨æˆ·ï¼Œç­‰å¾…å“åº”
    return await this.promptUser({
      checkpoint,
      options: [
        { label: 'âœ“ ç»§ç»­', action: 'continue' },
        { label: 'âœ ä¿®æ”¹', action: 'revise', prompt: 'è¯·è¯´æ˜ä¿®æ”¹å»ºè®®' },
        { label: 'â†º å›æ»š', action: 'rollback', toStep: checkpoint.stepNumber - 1 },
        { label: 'âœ• ä¸­æ­¢', action: 'abort' }
      ]
    });
  }
  
  rollback(toStep: number): void {
    if (!this.state) return;
    
    this.state.currentStep = toStep;
    this.state.checkpoints = this.state.checkpoints.filter(
      cp => cp.stepNumber <= toStep
    );
    this.state.status = 'active';
    this.saveState();
  }
  
  abort(): void {
    if (this.state) {
      this.state.status = 'aborted';
      this.saveState();
    }
  }
  
  private saveState(): void {
    if (this.state) {
      updateWorkingState({ chainState: this.state });
    }
  }
}

// é…ç½®
interface ChainConfig {
  enabled: boolean;  // ç”¨æˆ·å¯å…³é—­
  checkpointInterval: number;  // æ¯Næ­¥ä¸€ä¸ªcheckpoint
  maxCheckpoints: number;  // æœ€å¤§checkpointæ•°
}
```

---

## å››ã€éªŒæ”¶æ ‡å‡†

### 4.1 åŠŸèƒ½éªŒæ”¶ (ç°å®ç›®æ ‡)

| åŠŸèƒ½ | ç›®æ ‡ | æœ€ä½å¯æ¥å— | æµ‹è¯•æ–¹æ³• |
|-----|------|-----------|---------|
| è·¯ç”±åˆ†ç±» | 80% | 75% | 100æ¡æ ·æœ¬æµ‹è¯• |
| æ·±åº¦è¦†ç›– | 95% | 90% | ç”¨æˆ·æ˜¾å¼æŒ‡ä»¤æµ‹è¯• |
| è®°å¿†å¬å› | 60% | 50% | 20ä¸ªæŸ¥è¯¢æµ‹è¯• |
| è®°å¿†é‡‡ç”¨ | 40% | 30% | ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡ |
| é•¿é“¾è·¯(3æ­¥) | 75% | 65% | 10ä¸ªä»»åŠ¡æµ‹è¯• |
| é•¿é“¾è·¯(5æ­¥) | 65% | 55% | 10ä¸ªä»»åŠ¡æµ‹è¯• |
| ç½®ä¿¡åº¦æ ¡å‡† | 70% | 60% | å¯¹æ¯”æµ‹è¯• |
| ç”¨æˆ·æ»¡æ„åº¦ | 4.0/5 | 3.5/5 | é—®å·è°ƒæŸ¥ |

### 4.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡ | æµ‹è¯•æ–¹æ³• |
|-----|------|---------|
| å“åº”æ—¶é—´ (light) | <1s | å¹³å‡å“åº”æ—¶é—´ |
| å“åº”æ—¶é—´ (standard) | <3s | å¹³å‡å“åº”æ—¶é—´ |
| å“åº”æ—¶é—´ (deep) | <10s | å¹³å‡å“åº”æ—¶é—´ |
| Tokenæ•ˆç‡ | èŠ‚çœ>25% | å¯¹æ¯”åŸºçº¿ |
| é”™è¯¯ç‡ | <5% | é”™è¯¯æ—¥å¿— |
| ç”¨æˆ·å¹²é¢„ç‡ | <30% | è¡Œä¸ºç»Ÿè®¡ |

### 4.3 å¯ç»´æŠ¤æ€§éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡ |
|-----|------|
| ä»£ç è¡Œæ•° | <4000è¡Œ |
| æµ‹è¯•è¦†ç›–ç‡ | >70% |
| æ–‡æ¡£å®Œæ•´åº¦ | æ ¸å¿ƒåŠŸèƒ½100% |
| é…ç½®é¡¹æ•°é‡ | <30ä¸ª |

---

## äº”ã€å®æ–½è®¡åˆ’

### 5.1 8å‘¨å¼€å‘è®¡åˆ’

```
Week 1: åŸºç¡€è®¾æ–½
â”œâ”€â”€ Day 1-2: é¡¹ç›®ç»“æ„ï¼Œæ–‡ä»¶IOå°è£…
â”œâ”€â”€ Day 3-4: é…ç½®ç³»ç»Ÿï¼ŒWORKING.mdç®¡ç†
â””â”€â”€ Day 5: åŸºç¡€æµ‹è¯•æ¡†æ¶

Week 2: è·¯ç”±å±‚
â”œâ”€â”€ Day 1-2: è¾“å…¥åˆ†ç±»å™¨å®ç°
â”œâ”€â”€ Day 3-4: å…³é”®è¯é…ç½®ï¼Œæ·±åº¦å†³ç­–
â””â”€â”€ Day 5: è·¯ç”±æµ‹è¯•ï¼Œè°ƒä¼˜

Week 3: æ‰§è¡Œå±‚
â”œâ”€â”€ Day 1-2: ä¸Šä¸‹æ–‡ç»„è£…
â”œâ”€â”€ Day 3-4: LLMè°ƒç”¨å°è£…
â””â”€â”€ Day 5: ç½®ä¿¡åº¦è¯„ä¼°

Week 4: è®°å¿†å±‚
â”œâ”€â”€ Day 1-2: å·¥ä½œè®°å¿†ç®¡ç†
â”œâ”€â”€ Day 3-4: é•¿æœŸè®°å¿†æ£€ç´¢
â””â”€â”€ Day 5: è®°å¿†æç¤ºUI

Week 5: é“¾è·¯å±‚ + é›†æˆ
â”œâ”€â”€ Day 1-2: Checkpointæœºåˆ¶
â”œâ”€â”€ Day 3-4: ç³»ç»Ÿé›†æˆ
â””â”€â”€ Day 5: ç«¯åˆ°ç«¯æµ‹è¯•

Week 6: æµ‹è¯•ä¼˜åŒ–
â”œâ”€â”€ Day 1-2: è·¯ç”±å‡†ç¡®ç‡ä¼˜åŒ–
â”œâ”€â”€ Day 3-4: è¾¹ç•Œæƒ…å†µå¤„ç†
â””â”€â”€ Day 5: æ€§èƒ½ä¼˜åŒ–

Week 7: ç”¨æˆ·æµ‹è¯•
â”œâ”€â”€ Day 1-3: å†…éƒ¨æµ‹è¯•ï¼Œæ”¶é›†åé¦ˆ
â”œâ”€â”€ Day 4-5: è¿­ä»£æ”¹è¿›

Week 8: æ–‡æ¡£å‘å¸ƒ
â”œâ”€â”€ Day 1-3: æ–‡æ¡£ç¼–å†™
â”œâ”€â”€ Day 4: æœ€ç»ˆæµ‹è¯•
â””â”€â”€ Day 5: å‘å¸ƒ
```

### 5.2 é‡Œç¨‹ç¢‘

| é‡Œç¨‹ç¢‘ | æ—¶é—´ | éªŒæ”¶æ ‡å‡† |
|-------|------|---------|
| M1: åŸºç¡€è®¾æ–½ | Week 1 | æ–‡ä»¶è¯»å†™æ­£å¸¸ï¼Œé…ç½®åŠ è½½æˆåŠŸ |
| M2: è·¯ç”±å±‚ | Week 2 | 80%æ ·æœ¬æ­£ç¡®åˆ†ç±» |
| M3: æ‰§è¡Œå±‚ | Week 3 | ä¸‰ç§æ·±åº¦æ­£å¸¸è¾“å‡º |
| M4: è®°å¿†å±‚ | Week 4 | è®°å¿†æ£€ç´¢å¬å›ç‡>60% |
| M5: é“¾è·¯å±‚ | Week 5 | Checkpointæµç¨‹å®Œæ•´ |
| M6: é›†æˆæµ‹è¯• | Week 6 | ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡ |
| M7: ç”¨æˆ·æµ‹è¯• | Week 7 | æ»¡æ„åº¦>4.0/5 |
| M8: å‘å¸ƒ | Week 8 | æ–‡æ¡£å®Œæ•´ï¼Œæ— é˜»å¡bug |

---

## å…­ã€é£é™©ç¼“è§£

### 6.1 è¯†åˆ«é£é™©

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£ç­–ç•¥ |
|-----|------|------|---------|
| è·¯ç”±å‡†ç¡®ç‡ä¸è¾¾æ ‡ | ä¸­ | é«˜ | æä¾›æ˜¾å¼è¦†ç›–ï¼Œç”¨æˆ·å¯çº æ­£ |
| ç”¨æˆ·ä¸æ¥å—æ‰‹åŠ¨è®°å¿† | é«˜ | ä¸­ | ä¸€é”®ç¡®è®¤ï¼Œé™ä½è´Ÿæ‹…ï¼›å¯å…³é—­æç¤º |
| Checkpointè¢«å…³é—­ | ä¸­ | ä¸­ | å¯é…ç½®å…³é—­ï¼›3æ­¥ä»¥å†…ä»»åŠ¡ä¸å¯ç”¨ |
| å¼€å‘æ—¶é—´è¶…æœŸ | ä¸­ | é«˜ | æ¯å‘¨è¯„å®¡ï¼Œå¿…è¦æ—¶è£å‰ªåŠŸèƒ½ |
| æ€§èƒ½ä¸è¾¾æ ‡ | ä½ | ä¸­ | æ—©æœŸæ€§èƒ½æµ‹è¯•ï¼ŒåŠæ—¶ä¼˜åŒ– |

### 6.2 é™çº§ç­–ç•¥

```
å¦‚æœè·¯ç”±å‡†ç¡®ç‡ < 75%:
  â†’ å¢åŠ æ›´å¤šå…³é”®è¯
  â†’ å¼•å…¥ç®€å•æœºå™¨å­¦ä¹ ï¼ˆæœ´ç´ è´å¶æ–¯ï¼‰

å¦‚æœè®°å¿†é‡‡ç”¨ç‡ < 30%:
  â†’ ç®€åŒ–æç¤ºUI
  â†’ æ”¹ä¸º"è‡ªåŠ¨è®°å½•ï¼Œç”¨æˆ·å¯åˆ é™¤"æ¨¡å¼

å¦‚æœCheckpointä½¿ç”¨ç‡ < 30%:
  â†’ é»˜è®¤å…³é—­ï¼Œç”¨æˆ·æ‰‹åŠ¨å¼€å¯
  â†’ ä»…ç”¨äº>5æ­¥çš„ä»»åŠ¡

å¦‚æœæ—¶é—´è¶…æœŸ:
  â†’ è£å‰ª: å…ˆå»æ‰è®°å¿†æç¤º
  â†’ è£å‰ª: Checkpointæ”¹ä¸ºä»…è®°å½•ï¼Œä¸æš‚åœ
```

---

## ä¸ƒã€æ¼”è¿›è·¯çº¿

### 7.1 ç‰ˆæœ¬è§„åˆ’

```
v2.1 (å½“å‰): ç°å®è·¯çº¿åŸºç¡€ç‰ˆ
â”œâ”€â”€ ç®€å•è·¯ç”± (80%å‡†ç¡®ç‡)
â”œâ”€â”€ æ‰‹åŠ¨è®°å¿†ç®¡ç†
â”œâ”€â”€ å¯é€‰Checkpoint
â””â”€â”€ 8å‘¨å¼€å‘

v2.2 (æœªæ¥): ä½“éªŒä¼˜åŒ–ç‰ˆ
â”œâ”€â”€ è·¯ç”±å‡†ç¡®ç‡æå‡åˆ°85%
â”œâ”€â”€ è®°å¿†æç¤ºä¼˜åŒ–ï¼Œé‡‡ç”¨ç‡æå‡åˆ°50%
â”œâ”€â”€ å¼•å…¥ç®€å•å‘é‡æ£€ç´¢
â””â”€â”€ 4å‘¨å¼€å‘

v2.3 (æœªæ¥): æ™ºèƒ½å¢å¼ºç‰ˆ
â”œâ”€â”€ è½»é‡æ¨¡å‹å¾®è°ƒ
â”œâ”€â”€ è‡ªåŠ¨è®°å¿†æ‘˜è¦
â”œâ”€â”€ æ™ºèƒ½Checkpointæ”¾ç½®
â””â”€â”€ 6å‘¨å¼€å‘

v3.0 (è¿œæœŸ): å®Œæ•´è®¤çŸ¥æ¶æ„
â”œâ”€â”€ å¼•å…¥ç¬¬ä¸€ç‰ˆè®¾è®¡çš„éƒ¨åˆ†èƒ½åŠ›
â”œâ”€â”€ åœ¨ç¨³å®šåŸºç¡€ä¸Šå¢åŠ å¤æ‚åº¦
â””â”€â”€ è§†v2.xåé¦ˆå†³å®š
```

### 7.2 æˆåŠŸæŒ‡æ ‡

| ç‰ˆæœ¬ | ç›®æ ‡ |
|-----|------|
| v2.1 | å¯ç”¨ï¼Œç¨³å®šï¼Œç”¨æˆ·æ»¡æ„åº¦>4.0 |
| v2.2 | ä½“éªŒæµç•…ï¼Œä¸»åŠ¨ä½¿ç”¨ç‡>50% |
| v2.3 | æ™ºèƒ½æ„ŸçŸ¥ï¼Œç”¨æˆ·ä¾èµ–åº¦æå‡ |
| v3.0 | è¡Œä¸šé¢†å…ˆçš„ä¸ªäººAgent |

---

## å…«ã€æ€»ç»“

### 8.1 æ ¸å¿ƒè°ƒæ•´

| æ–¹é¢ | åŸå§‹ | ç°å®ç‰ˆ |
|-----|------|--------|
| è·¯ç”±å‡†ç¡®ç‡ | 90% | 80% |
| è®°å¿†å¬å› | 80% | 60% |
| é•¿é“¾è·¯ | 80% | 65% |
| ä»£ç è¡Œæ•° | <3000 | <4000 |
| å¼€å‘æ—¶é—´ | 4å‘¨ | 8å‘¨ |
| ç”¨æˆ·æ»¡æ„åº¦ | 4.5/5 | 4.0/5 |

### 8.2 å…³é”®è®¾è®¡

1. **ç”¨æˆ·å¯çº æ­£**: æ˜¾å¼æ·±åº¦æŒ‡ä»¤è¦†ç›–è·¯ç”±
2. **ä¸€é”®ç¡®è®¤**: é™ä½è®°å¿†ç®¡ç†è´Ÿæ‹…
3. **å¯é…ç½®**: Checkpointå¯å…³é—­
4. **æ¸è¿›**: å…ˆå¯ç”¨ï¼Œå†ä¼˜åŒ–

### 8.3 æœ€ç»ˆç›®æ ‡

**ä¸æ˜¯"å®Œç¾çš„AI"ï¼Œè€Œæ˜¯"å¯é çš„ã€ç”¨æˆ·å¯æ§çš„åŠ©æ‰‹"ã€‚**

---

*è®¾è®¡å®Œæˆ*
*ç‰ˆæœ¬: 2.1 Reality Edition*
*æ—¥æœŸ: 2026-02-19*
